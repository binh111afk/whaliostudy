// ==================== CONFIGURATION ====================
const CONFIG = {
    STORAGE_KEYS: {
        LOGIN_STATUS: 'isWhalioLoggedIn',
        CURRENT_USER: 'currentUser'
    },
    API_ENDPOINTS: {
        LOGIN: '/api/login',
        DOCUMENTS: '/api/documents',
        TOGGLE_SAVE: '/api/toggle-save-doc',
        UPLOAD: '/api/upload-document'
    },
    FILE_TYPES: {
        word: { class: 'icon-word', text: 'DOC', color: '#2B579A' },
        excel: { class: 'icon-excel', text: 'XLS', color: '#217346' },
        ppt: { class: 'icon-ppt', text: 'PPT', color: '#D24726' },
        pdf: { class: 'icon-pdf', text: 'PDF', color: '#F40F02' },
        image: { class: 'icon-image', text: 'IMG', color: '#FF6B35' }
    }
};

// ==================== DOM ELEMENTS ====================
const DOM = {
    // Modals (Gi·ªØ nguy√™n)
    modals: {
        // ... code c≈© ...
        login: document.getElementById('loginModal'),
        register: document.getElementById('registerModal'),
        logout: document.getElementById('logoutModal'),
        forgot: document.getElementById('forgotPassModal'),
        editProfile: document.getElementById('editProfileModal'),
        changePass: document.getElementById('changePassModal'),
        uploadDoc: document.getElementById('uploadDocModal'),
        alert: document.getElementById('customAlert')
    },

    // --- S·ª¨A ƒêO·∫†N N√ÄY ---
    // 1. T·∫†O M·ªòT NH√ìM M·ªöI CHO HEADER
    actions: {
        guestActions: document.getElementById('guest-actions'),
        userActions: document.getElementById('user-actions'),
    },

    // 2. X√ìA 2 D√íNG guestActions V√Ä userActions KH·ªéI SECTIONS
    sections: {
        // guestActions: ... (X√ìA D√íNG N√ÄY)
        // userActions: ... (X√ìA D√íNG N√ÄY)
        mainDashboard: document.getElementById('main-dashboard'),
        profileSection: document.getElementById('profile-section'),
        documentsSection: document.getElementById('documents-section'),
        examsSection: document.getElementById('exams-section'),
        communitySection: document.getElementById('community-section')
    },
    // ... code c≈© containers, alert, ui ...
    containers: {
        docList: document.getElementById('document-list-container'),
        documentsList: document.getElementById('documents-list-container')
    },
    alert: {
        icon: document.getElementById('alertIcon'),
        title: document.getElementById('alertTitle'),
        message: document.getElementById('alertMessage')
    },
    ui: {
        userDropdown: document.getElementById('userDropdown'),
        sidebarProfile: document.querySelector('.user-mini-profile'),
        welcomeText: document.querySelector('.welcome-info h1'),
        dateText: document.querySelector('.welcome-info p'),
        sectionTitle: document.querySelector('.section-title'),
        pageTitle: document.querySelector('.page-title h1'),
        pageSubtitle: document.querySelector('.page-title p')
    }
};

// ==================== STATE MANAGEMENT ====================
const AppState = {
    currentUser: null,
    allDocuments: [],
    allCourses: [],
    isViewingSaved: false,
    isLoading: false,

    // Initialize from localStorage
    init() {
        const isLoggedIn = localStorage.getItem(CONFIG.STORAGE_KEYS.LOGIN_STATUS);
        const savedUser = localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_USER);

        if (isLoggedIn === 'true' && savedUser) {
            this.currentUser = JSON.parse(savedUser);
            return true;
        }
        return false;
    },

    // Save user to localStorage
    saveUser(user) {
        this.currentUser = user;
        localStorage.setItem(CONFIG.STORAGE_KEYS.LOGIN_STATUS, 'true');
        localStorage.setItem(CONFIG.STORAGE_KEYS.CURRENT_USER, JSON.stringify(user));
    },

    // Clear user data
    clearUser() {
        this.currentUser = null;
        localStorage.removeItem(CONFIG.STORAGE_KEYS.LOGIN_STATUS);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_USER);
    }
};

// ==================== UTILITY FUNCTIONS ====================
const Utils = {
    // DOM Utilities
    showElement(el, display = 'block') {
        if (el) el.style.display = display;
    },

    hideElement(el) {
        if (el) el.style.display = 'none';
    },

    // Button Loading State
    setButtonLoading(button, isLoading) {
        if (!button) return;

        if (isLoading) {
            button.dataset.originalText = button.textContent;
            button.textContent = 'ƒêang x·ª≠ l√Ω...';
            button.disabled = true;
            button.style.opacity = '0.7';
        } else {
            if (button.dataset.originalText) {
                button.textContent = button.dataset.originalText;
            }
            button.disabled = false;
            button.style.opacity = '1';
        }
    },

    // Alert System
    showAlert(title, message, isSuccess = true, duration = 3000) {
        if (!DOM.modals.alert) return;

        DOM.alert.icon.textContent = isSuccess ? '‚úÖ' : '‚ö†Ô∏è';
        DOM.alert.title.textContent = title;
        DOM.alert.message.textContent = message;

        DOM.modals.alert.classList.add('active');

        setTimeout(() => {
            this.closeAlert();
        }, duration);
    },

    closeAlert() {
        if (DOM.modals.alert) {
            DOM.modals.alert.classList.remove('active');
        }
    },

    // File Utilities
    getFileType(type) {
        return CONFIG.FILE_TYPES[type] || { class: 'icon-other', text: 'FILE', color: '#6C757D' };
    },

    formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';

        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }

        return `${size.toFixed(1)} ${units[unitIndex]}`;
    },

    // String Utilities
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    // Date Utilities
    getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return "Ch√†o bu·ªïi s√°ng";
        if (hour < 18) return "Ch√†o bu·ªïi chi·ªÅu";
        return "Ch√†o bu·ªïi t·ªëi";
    },

    getCurrentDate() {
        return new Date().toLocaleDateString('vi-VN', {
            weekday: 'long',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }
};

// ==================== MODAL MANAGEMENT ====================
const ModalManager = {
    // Close all modals
    closeAll() {
        Object.values(DOM.modals).forEach(modal => {
            if (modal) modal.classList.remove('active');
        });
    },

    // Open specific modal
    open(modalName) {
        this.closeAll();
        const modal = DOM.modals[modalName];
        if (modal) modal.classList.add('active');
    },

    // Close specific modal
    close(modalName) {
        const modal = DOM.modals[modalName];
        if (modal) modal.classList.remove('active');
    },

    // Setup click outside to close
    setupCloseListeners() {
        Object.values(DOM.modals).forEach(modal => {
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            }
        });
    }
};

// ==================== AUTHENTICATION ====================
const Auth = {
    // Handle login
    async login(username, password) {
        try {
            const response = await fetch(CONFIG.API_ENDPOINTS.LOGIN, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            return await response.json();
        } catch (error) {
            console.error('Login error:', error);
            return { success: false, message: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server!' };
        }
    },

    // Handle logout
    logout() {
        StatsManager.stopStudyTimer(); // <--- TH√äM D√íNG N√ÄY (D·ª´ng ƒë·∫øm gi·ªù c·ªßa user c≈©)
        AppState.clearUser();
        location.reload();
    }
};

// ==================== USER INTERFACE ====================
const UI = {
    // Show user interface
    showUserInterface(user) {
        // S·ª¨A DOM.sections TH√ÄNH DOM.actions
        Utils.hideElement(DOM.actions.guestActions);
        Utils.showElement(DOM.actions.userActions, 'flex');

        if (DOM.ui.sidebarProfile) {
            DOM.ui.sidebarProfile.style.display = 'flex';
        }

        this.updateUserInfo(user);
        this.updateWelcomeMessage(user.fullName);
    },

    // Show guest interface
    showGuestInterface() {
        // S·ª¨A DOM.sections TH√ÄNH DOM.actions
        Utils.showElement(DOM.actions.guestActions);
        Utils.hideElement(DOM.actions.userActions);

        if (DOM.ui.sidebarProfile) {
            DOM.ui.sidebarProfile.style.display = 'none';
        }

        if (DOM.ui.welcomeText) {
            DOM.ui.welcomeText.textContent = "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Whalio!";
        }
    },
    // Update user information
    updateUserInfo(user) {
        // Render avatar
        this.renderAvatar(user.avatar);

        // Update names
        const sidebarName = document.querySelector('.user-name');
        if (sidebarName) {
            sidebarName.innerHTML = user.fullName.replace(' ', '<br>');
        }

        const menuName = document.getElementById('menuUserName');
        if (menuName) menuName.textContent = user.fullName;
    },

    // Update welcome message
    updateWelcomeMessage(userName) {
        if (DOM.ui.welcomeText) {
            const greeting = Utils.getGreeting();
            DOM.ui.welcomeText.textContent = greeting + ', ' + userName + '! üëã';
        }

        if (DOM.ui.dateText) {
            DOM.ui.dateText.textContent = "H√¥m nay l√† " + Utils.getCurrentDate();
        }
    },

    // Render avatar
    renderAvatar(avatarValue) {
        const avatarElements = document.querySelectorAll('.nav-avatar, .user-mini-profile .avatar, .large-avatar, .avatar-small');

        avatarElements.forEach(el => {
            if (avatarValue && avatarValue.includes('/uploads/')) {
                el.textContent = '';
                el.style.backgroundImage = "url('" + avatarValue + "')";
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.color = 'transparent';
            } else {
                el.textContent = avatarValue || 'U';
                el.style.backgroundImage = 'none';
                el.style.color = '';
            }
        });
    },

    // Update section title
    updateSectionTitle(isSaved = false) {
        if (DOM.ui.sectionTitle) {
            DOM.ui.sectionTitle.innerHTML = isSaved ?
                '<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg> T√ÄI LI·ªÜU ƒê√É L∆ØU' :
                '<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg> KHO T√ÄI LI·ªÜU CHUNG';
        }
    },

    // Update page title
    updatePageTitle(isSaved = false) {
        if (DOM.ui.pageTitle) {
            DOM.ui.pageTitle.innerHTML = isSaved ?
                'T√†i Li·ªáu ƒê√£ L∆∞u' :
                'Kho T√†i Li·ªáu Chung';
        }

        if (DOM.ui.pageSubtitle) {
            DOM.ui.pageSubtitle.textContent = isSaved ?
                'Danh s√°ch t√†i li·ªáu b·∫°n ƒë√£ l∆∞u' :
                'T·ªïng h·ª£p t√†i li·ªáu h·ªçc t·∫≠p t·ª´ c√°c th√†nh vi√™n';
        }
    },

    // Set active menu
    setActiveMenu(menuItem) {
        document.querySelectorAll('.nav-menu a').forEach(el => {
            el.classList.remove('active');
        });
        if (menuItem) menuItem.classList.add('active');
    },

    // Set active nav item (header)
    setActiveNavItem(navItemId) {
        document.querySelectorAll('.nav-center .nav-item').forEach(el => {
            el.classList.remove('active');
        });
        if (navItemId) {
            const navItem = document.getElementById(navItemId);
            if (navItem) navItem.classList.add('active');
        }
    }
};

// ==================== DOCUMENT MANAGER (FIX L·ªñI POPUP X√ìA) ====================
const DocumentManager = {
    // State
    pendingDocId: null,
    pendingDocUser: null,
    
    currentMode: 'normal',
    pagination: { currentPage: 1, itemsPerPage: 9 },
    currentFilteredDocs: [],

    // 1. T·∫£i t√†i li·ªáu
    async loadAllDocuments() {
        if (AppState.isLoading) return;
        AppState.isLoading = true;
        try {
            const response = await fetch(CONFIG.API_ENDPOINTS.DOCUMENTS);
            AppState.allDocuments = await response.json();
            
            if (AppState.isViewingSaved) {
                this.currentFilteredDocs = AppState.allDocuments.filter(doc => 
                    AppState.currentUser?.savedDocs?.includes(doc.id)
                );
            } else {
                this.currentFilteredDocs = [...AppState.allDocuments];
            }

            this.pagination.currentPage = 1;
            this.renderPagedDocuments(); 
            this.updateStats();
        } catch (error) {
            console.error('Load documents error:', error);
        } finally {
            AppState.isLoading = false;
        }
    },

    // 1.5 Load courses and populate dropdown
    async loadCourses() {
        try {
            // Danh s√°ch m√¥n h·ªçc (kh√¥ng c√≥ icons)
            AppState.allCourses = [
                { id: 1, name: "Gi·∫£i t√≠ch 1", code: "GT1" },
                { id: 2, name: "ƒê·∫°i s·ªë tuy·∫øn t√≠nh", code: "DSTD" },
                { id: 3, name: "V·∫≠t l√Ω 1", code: "VL1" },
                { id: 4, name: "H√≥a h·ªçc", code: "HH" },
                { id: 5, name: "Ti·∫øng Anh", code: "TA" },
                { id: 6, name: "L·∫≠p tr√¨nh C++", code: "LP" },
                { id: 7, name: "C∆° s·ªü d·ªØ li·ªáu", code: "CSDL" },
                { id: 8, name: "Web Development", code: "WEB" },
                { id: 9, name: "Tri·∫øt h·ªçc M√°c Lenin", code: "TMML" },
                { id: 10, name: "Ph√°p lu·∫≠t ƒë·∫°i c∆∞∆°ng", code: "PLDC" },
                { id: 11, name: "T√¢m l√Ω h·ªçc ƒê·∫°i c∆∞∆°ng", code: "TLDC" }
            ];
            this.populateCourseDropdown();
        } catch (error) {
            console.error('Load courses error:', error);
        }
    },

    // Populate course dropdown in upload modal
    populateCourseDropdown() {
        const courseSelect = document.getElementById('docCourse');
        if (!courseSelect) return;

        // Clear existing options except the first one
        courseSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>';

        // Add courses (without icons, just names)
        AppState.allCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.name;
            courseSelect.appendChild(option);
        });

        // Add "Other documents" option
        const otherOption = document.createElement('option');
        otherOption.value = 'other';
        otherOption.textContent = 'T√†i li·ªáu kh√°c';
        courseSelect.appendChild(otherOption);
    },

    // 2. Render Giao di·ªán (T·ª± ƒë·ªông ch·ªçn n∆°i v·∫Ω)
    renderPagedDocuments() {
        let containerId = 'documents-list-container';
        let paginationId = 'pagination-container';
        
        // Thay ƒë·ªïi itemsPerPage d·ª±a tr√™n mode
        if (this.currentMode === 'library') {
            containerId = 'library-grid-container';
            paginationId = 'library-pagination';
            this.pagination.itemsPerPage = 9; // Library: 9 t√†i li·ªáu/trang
        } else {
            this.pagination.itemsPerPage = 8; // Dashboard: 8 t√†i li·ªáu/trang
        }

        const container = document.getElementById(containerId);
        if (!container) return;

        const start = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage;
        const end = start + this.pagination.itemsPerPage;
        const docsToShow = this.currentFilteredDocs.slice(start, end);

        if (docsToShow.length === 0) {
            this.renderEmptyState(
                AppState.isViewingSaved ? "B·∫°n ch∆∞a l∆∞u t√†i li·ªáu n√†o" : "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu",
                AppState.isViewingSaved ? 'üì≠' : 'üîç',
                container
            );
            const pageContainer = document.getElementById(paginationId);
            if(pageContainer) pageContainer.innerHTML = '';
            return;
        }

        container.innerHTML = this.generateCardsHTML(docsToShow);

        // Render pagination cho c·∫£ library v√† dashboard
        if (this.currentMode === 'library') {
            this.renderPaginationControl(paginationId);
        } else {
            // Render pagination cho dashboard n·∫øu c√≥ nhi·ªÅu h∆°n itemsPerPage
            const pageContainer = document.getElementById(paginationId);
            if (pageContainer && this.currentFilteredDocs.length > this.pagination.itemsPerPage) {
                this.renderPaginationControl(paginationId);
            } else if (pageContainer) {
                pageContainer.innerHTML = '';
            }
        }
    },

    // 3. T·∫°o HTML Th·∫ª Card (Chu·∫©n Style c≈©)
    generateCardsHTML(docs) {
        const isAdmin = AppState.currentUser && AppState.currentUser.role === 'admin';
        const currentUsername = AppState.currentUser ? AppState.currentUser.username : "";
        const savedList = AppState.currentUser?.savedDocs || [];

        return docs.map(doc => {
            const isSaved = savedList.includes(doc.id);
            const fileType = Utils.getFileType(doc.type);
            const uploadDate = doc.time ? `${doc.date} ${doc.time}` : doc.date;
            
            const extension = doc.path.substring(doc.path.lastIndexOf('.'));
            let downloadFileName = doc.name;
            if (!downloadFileName.toLowerCase().endsWith(extension.toLowerCase())) {
                downloadFileName += extension;
            }

            // Get course name and code
            let courseName = '';
            let courseCode = '';
            if (doc.course && doc.course !== 'other') {
                const course = AppState.allCourses.find(c => c.id == doc.course);
                if (course) {
                    courseName = course.name;
                    courseCode = course.code;
                }
            }
            if (!courseName) {
                courseName = 'T√†i li·ªáu kh√°c';
                courseCode = 'OTHER';
            }

            // Check if user can edit this document
            const canEdit = isAdmin || doc.uploader === AppState.currentUser?.fullName;

            // N√∫t x√≥a Admin (D√πng class .admin-delete-btn)
            const deleteBtn = isAdmin ? `
                <button class="admin-delete-btn" 
                        onclick="event.stopPropagation(); DocumentManager.openDeleteModal(${doc.id}, '${currentUsername}')" 
                        title="X√≥a vƒ©nh vi·ªÖn">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            ` : '';

            // Edit button
            const editBtn = canEdit ? `
                <button class="doc-card-btn btn-edit-card" onclick="event.stopPropagation(); DocumentManager.openEditModal(${doc.id})" title="S·ª≠a th√¥ng tin">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    <span>S·ª≠a</span>
                </button>
            ` : '';

            return `
                <div class="doc-card" data-id="${doc.id}" onclick="window.open('${doc.path}', '_blank')">
                    ${deleteBtn}
                    <div class="doc-card-header">
                        <div class="doc-card-icon ${fileType.class}" style="background-color: ${fileType.color}20; color: ${fileType.color}">
                            ${fileType.text}
                        </div>
                        <div class="doc-card-info">
                            <h3 title="${Utils.escapeHtml(doc.name)}">${Utils.escapeHtml(doc.name)}</h3>
                            <div class="doc-uploader">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                ${Utils.escapeHtml(doc.uploader)}
                            </div>
                            <div class="doc-course-badge" title="${Utils.escapeHtml(courseName)}">
                                <span class="course-code">${courseCode}</span>
                            </div>
                        </div>
                    </div>
                    <div class="doc-card-body">
                        <div class="doc-meta-info">
                            <div class="doc-meta-item">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                ${uploadDate}
                            </div>
                            ${doc.size ? `<div class="doc-meta-item">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                                    <path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                </svg>
                                ${Utils.formatFileSize(doc.size)}</div>` : ''}
                        </div>
                        <div class="doc-card-actions">
                            <button class="doc-card-btn btn-view" onclick="event.stopPropagation(); window.open('${doc.path}', '_blank')">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <span>Xem</span>
                            </button>
                            ${editBtn}
                            <button class="doc-card-btn btn-save-card ${isSaved ? 'saved' : ''}" onclick="event.stopPropagation(); DocumentManager.toggleSave(${doc.id})">
                                ${isSaved ? '<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>' : '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>'}
                            </button>
                            <a href="${doc.path}" download="${downloadFileName}" class="doc-card-btn btn-download-card" onclick="event.stopPropagation(); DocumentManager.trackDownload(${doc.id})">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                <span>T·∫£i</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },

    // --- 4. H·ªÜ TH·ªêNG X·ª¨ L√ù MODAL X√ìA (ƒê√É FIX) ---

    // M·ªü Modal
    openDeleteModal(docId, username) {
        // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc ti√™n
        if (!AppState.currentUser || AppState.currentUser.role !== 'admin') {
            Utils.showAlert("L·ªói", "Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ x√≥a t√†i li·ªáu!", false);
            return;
        }

        this.pendingDocId = docId;
        this.pendingDocUser = username;
        
        // T√¨m tr·ª±c ti·∫øp b·∫±ng ID (Kh√¥ng d√πng bi·∫øn DOM c≈©)
        const modal = document.getElementById('deleteDocConfirmModal');
        if (modal) modal.classList.add('active');
        else console.error("L·ªói: Kh√¥ng t√¨m th·∫•y Modal deleteDocConfirmModal");
    },

    // ƒê√≥ng Modal (N√∫t H·ªßy)
    closeDeleteModal() {
        this.pendingDocId = null;
        this.pendingDocUser = null;

        // T√¨m tr·ª±c ti·∫øp ƒë·ªÉ ƒë√≥ng
        const modal = document.getElementById('deleteDocConfirmModal');
        if (modal) modal.classList.remove('active');
    },

    // X√°c nh·∫≠n X√≥a (N√∫t X√≥a ngay)
    async confirmDeleteAction() {
        if (!this.pendingDocId) {
            // Tr∆∞·ªùng h·ª£p l·ªói logic, ƒë√≥ng modal lu√¥n
            this.closeDeleteModal();
            return;
        }

        // T√¨m Modal v√† N√∫t b·∫•m ƒë·ªÉ hi·ªÉn th·ªã loading
        const modal = document.getElementById('deleteDocConfirmModal');
        // T√¨m n√∫t "X√≥a ngay" (th∆∞·ªùng l√† n√∫t th·ª© 2 trong modal)
        const buttons = modal ? modal.querySelectorAll('button') : [];
        const btnDelete = buttons.length > 0 ? buttons[buttons.length - 1] : null; // L·∫•y n√∫t cu·ªëi c√πng
        
        const originalText = btnDelete ? btnDelete.textContent : "X√≥a ngay";

        if(btnDelete) {
            btnDelete.textContent = "ƒêang x√≥a...";
            btnDelete.disabled = true;
        }

        try {
            const response = await fetch('/api/delete-document', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ docId: this.pendingDocId, username: this.pendingDocUser })
            });
            const result = await response.json();
            
            if (result.success) {
                // ƒê√≥ng modal TR∆Ø·ªöC khi load l·∫°i ƒë·ªÉ giao di·ªán m∆∞·ª£t
                this.closeDeleteModal(); 
                await this.loadAllDocuments();
                Utils.showAlert("ƒê√£ x√≥a", "T√†i li·ªáu ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn! üóëÔ∏è", true);
            } else {
                alert("‚ùå L·ªói: " + result.message);
                this.closeDeleteModal();
            }
        } catch (error) {
            alert("L·ªói k·∫øt n·ªëi Server!");
            this.closeDeleteModal();
        } finally {
            // Tr·∫£ l·∫°i tr·∫°ng th√°i n√∫t (ƒë·ªÅ ph√≤ng m·ªü l·∫°i l·∫ßn sau)
            if(btnDelete) {
                btnDelete.textContent = originalText;
                btnDelete.disabled = false;
            }
        }
    },

    // ===== EDIT DOCUMENT FUNCTIONS =====
    editingDocId: null,

    // Open edit modal
    openEditModal(docId) {
        const doc = AppState.allDocuments.find(d => d.id === docId);
        if (!doc) {
            Utils.showAlert("L·ªói", "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu!", false);
            return;
        }

        // Check permission
        const isAdmin = AppState.currentUser && AppState.currentUser.role === 'admin';
        const canEdit = isAdmin || doc.uploader === AppState.currentUser?.fullName;

        if (!canEdit) {
            Utils.showAlert("L·ªói", "B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a t√†i li·ªáu n√†y!", false);
            return;
        }

        // Set document data
        this.editingDocId = docId;
        document.getElementById('editDocName').value = doc.name;
        document.getElementById('editDocCourse').value = doc.course || '';

        // Populate course dropdown
        this.populateEditCourseDropdown();

        // Show modal
        const modal = document.getElementById('editDocModal');
        if (modal) modal.classList.add('active');
    },

    // Close edit modal
    closeEditModal() {
        this.editingDocId = null;
        const modal = document.getElementById('editDocModal');
        if (modal) modal.classList.remove('active');
    },

    // Populate course dropdown in edit modal
    populateEditCourseDropdown() {
        const courseSelect = document.getElementById('editDocCourse');
        if (!courseSelect) return;

        // Clear existing options except the first one
        courseSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>';

        // Add courses (without icons)
        AppState.allCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.name;
            courseSelect.appendChild(option);
        });

        // Add "Other documents" option
        const otherOption = document.createElement('option');
        otherOption.value = 'other';
        otherOption.textContent = 'T√†i li·ªáu kh√°c';
        courseSelect.appendChild(otherOption);
    },

    // Handle edit document submission
    async handleEditDocument(event) {
        event.preventDefault();

        if (!this.editingDocId) {
            Utils.showAlert("L·ªói", "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu c·∫ßn s·ª≠a!", false);
            return;
        }

        const newName = document.getElementById('editDocName').value.trim();
        const newCourse = document.getElementById('editDocCourse').value;

        if (!newName) {
            Utils.showAlert("L·ªói", "T√™n t√†i li·ªáu kh√¥ng ƒë∆∞·ª£c tr·ªëng!", false);
            return;
        }

        const btn = event.target.querySelector('button[type="submit"]');
        Utils.setButtonLoading(btn, true);

        try {
            const response = await fetch('/api/update-document', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    docId: this.editingDocId,
                    name: newName,
                    course: newCourse,
                    username: AppState.currentUser?.username
                })
            });

            const result = await response.json();

            if (result.success) {
                // Update in AppState
                const doc = AppState.allDocuments.find(d => d.id === this.editingDocId);
                if (doc) {
                    doc.name = newName;
                    doc.course = newCourse;
                }

                Utils.showAlert("Th√†nh c√¥ng!", "C·∫≠p nh·∫≠t t√†i li·ªáu th√†nh c√¥ng!", true);
                this.closeEditModal();
                this.renderPagedDocuments();
            } else {
                Utils.showAlert("L·ªói", result.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t√†i li·ªáu!", false);
            }
        } catch (error) {
            console.error('Edit document error:', error);
            Utils.showAlert("L·ªói", "L·ªói k·∫øt n·ªëi server!", false);
        } finally {
            Utils.setButtonLoading(btn, false);
        }
    },

    // Upload document function
    async uploadDocument(formData) {
        try {
            const response = await fetch('/api/upload-document', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('Upload document error:', error);
            return { success: false, message: 'L·ªói k·∫øt n·ªëi server' };
        }
    },

    // --- C√°c h√†m ti·ªán √≠ch kh√°c ---
    renderEmptyState(message, icon, container) {
        container.innerHTML = `
            <div class="docs-empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #9ca3af;">
                <div class="icon" style="font-size: 40px; margin-bottom: 10px;">${icon}</div>
                <h3 style="font-size: 16px; font-weight: 600;">${message}</h3>
                ${!AppState.isViewingSaved ? 
                    `<button class="btn-upload-header" onclick="ModalManager.open('uploadDoc')" style="margin-top: 15px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">T·∫£i t√†i li·ªáu l√™n</button>` : ''}
            </div>
        `;
    },
    
    renderPaginationControl(targetId) {
        const container = document.getElementById(targetId);
        if (!container) return;
        const totalPages = Math.ceil(this.currentFilteredDocs.length / this.pagination.itemsPerPage);
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        
        let html = '';
        html += `<button class="page-btn ${this.pagination.currentPage === 1 ? 'disabled' : ''}" onclick="DocumentManager.changePage(${this.pagination.currentPage - 1})">‚ùÆ</button>`;
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="page-btn ${this.pagination.currentPage === i ? 'active' : ''}" onclick="DocumentManager.changePage(${i})">${i}</button>`;
        }
        html += `<button class="page-btn ${this.pagination.currentPage === totalPages ? 'disabled' : ''}" onclick="DocumentManager.changePage(${this.pagination.currentPage + 1})">‚ùØ</button>`;
        container.innerHTML = html;
    },

    changePage(pageNum) {
        const totalPages = Math.ceil(this.currentFilteredDocs.length / this.pagination.itemsPerPage);
        if (pageNum < 1 || pageNum > totalPages) return;
        this.pagination.currentPage = pageNum;
        this.renderPagedDocuments();
        const targetId = this.currentMode === 'library' ? 'library-grid-container' : 'documents-list-container';
        document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    },

    toggleSave: async function(docId) { /* Logic c≈© */ 
        if (!AppState.currentUser) { Utils.showAlert("Th√¥ng b√°o", "Vui l√≤ng ƒëƒÉng nh·∫≠p!", false); return; }
        try {
            const res = await fetch(CONFIG.API_ENDPOINTS.TOGGLE_SAVE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: AppState.currentUser.username, docId}) });
            const data = await res.json();
            if(data.success) {
                AppState.currentUser.savedDocs = data.savedDocs; AppState.saveUser(AppState.currentUser);
                this.renderPagedDocuments();
                Utils.showAlert("Th√†nh c√¥ng", data.action==='saved'?'ƒê√£ l∆∞u':'ƒê√£ b·ªè l∆∞u', true);
            }
        } catch(e) { Utils.showAlert("L·ªói", "Kh√¥ng th·ªÉ l∆∞u", false); }
    },
    trackDownload: function(docId) { console.log('DL', docId); },
    updateStats: function() { 
        // C·∫≠p nh·∫≠t s·ªë li·ªáu t√†i li·ªáu
        const totalDocsEl = document.getElementById('total-docs');
        const savedDocsEl = document.getElementById('saved-docs');
        const recentDocsEl = document.getElementById('recent-docs');
        
        if (totalDocsEl) {
            totalDocsEl.textContent = AppState.allDocuments.length;
        }
        
        if (savedDocsEl && AppState.currentUser) {
            const savedCount = AppState.currentUser.savedDocs?.length || 0;
            savedDocsEl.textContent = savedCount;
        }
        
        if (recentDocsEl) {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCount = AppState.allDocuments.filter(doc => {
                return doc.createdAt && new Date(doc.createdAt) >= sevenDaysAgo;
            }).length;
            recentDocsEl.textContent = recentCount;
        }
        
        // T√≠nh dung l∆∞·ª£ng l∆∞u tr·ªØ t·ª´ danh s√°ch t√†i li·ªáu
        let totalSize = 0;
        let fileSize = 0;
        let imageSize = 0;

        AppState.allDocuments.forEach(doc => {
            const size = doc.size || 0;
            totalSize += size;
            
            // Ph√¢n lo·∫°i theo ki·ªÉu file
            if (doc.type === 'image') {
                imageSize += size;
            } else {
                fileSize += size;
            }
        });

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã storage
        const totalSizeMB = totalSize / (1024 * 1024);
        const fileSizeMB = fileSize / (1024 * 1024);
        const imageSizeMB = imageSize / (1024 * 1024);
        const totalQuotaMB = 10 * 1024; // 10 GB

        // Update storage number
        const storageEl = document.getElementById('storage-usage');
        if (storageEl) {
            storageEl.textContent = `${totalSizeMB.toFixed(1)} MB / ${totalQuotaMB} MB`;
        }

        // Update progress bar width
        const filePercent = (fileSizeMB / totalQuotaMB) * 100;
        const imagePercent = (imageSizeMB / totalQuotaMB) * 100;

        const barFile = document.getElementById('storage-bar-file');
        const barImage = document.ginnerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>orage-bar-image');
        
        if (barFile) barFile.style.width = Math.min(filePercent, 100) + '%';
        if (barImage) barImage.style.width = Math.min(imagePercent, 100) + '%';

        // Update storage details
        const fileSizeEl = document.getElementById('storage-file-size');
        const imageSizeEl = document.getElementById('storage-image-size');
        
        const folderIcon = '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>';
        const imageIcon = '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>';
        
        if (fileSizeEl) fileSizeEl.innerHTML = folderIcon + ' Files: ' + fileSizeMB.toFixed(1) + ' MB';
        if (imageSizeEl) imageSizeEl.innerHTML = imageIcon + ' ·∫¢nh: ' + imageSizeMB.toFixed(1) + ' MB';
    },

    // Current course filter
    currentCourseFilter: 'all',

    filterLibrary: function(type) {
        document.querySelectorAll('.type-filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if((!type && btn.textContent==='T·∫•t c·∫£') || (type && btn.textContent.toLowerCase().includes(type==='ppt'?'slide':type))) btn.classList.add('active');
        });
        this.filterByType(type==='all'?'':type);
    },

    searchLibrary: function(v) { this.searchDocuments(v); },

    filterByCourse: function(courseId) {
        // Update active button
        document.querySelectorAll('.course-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`.course-filter-btn[onclick*="filterByCourse('${courseId}')"]`) ||
                         document.querySelector(`.course-filter-btn[onclick*='filterByCourse(${courseId})']`);
        if (activeBtn) activeBtn.classList.add('active');

        // Filter documents
        this.currentCourseFilter = courseId;
        let src = AppState.allDocuments;

        if (courseId === 'all') {
            this.currentFilteredDocs = [...src];
        } else if (courseId === 'other') {
            this.currentFilteredDocs = src.filter(d => !d.course || d.course === 'other' || d.course === '');
        } else {
            this.currentFilteredDocs = src.filter(d => d.course == courseId);
        }

        this.pagination.currentPage = 1;
        this.renderPagedDocuments();
    },

    // Filter documents by course in documents-section
    filterDocsByCourse: function(courseId) {
        // Update active button
        document.querySelectorAll('.course-filter-buttons .course-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Find and activate the clicked button
        const btns = document.querySelectorAll('.course-filter-buttons .course-filter-btn');
        if (courseId === 'all') {
            btns[0].classList.add('active');
        } else {
            btns.forEach((btn, idx) => {
                const btnCourseId = btn.getAttribute('onclick').match(/\d+|'other'/);
                if (btnCourseId && (btnCourseId[0] == courseId || btnCourseId[0] === "'other'" && courseId === 'other')) {
                    btn.classList.add('active');
                }
            });
        }

        // Filter documents
        let src = AppState.allDocuments;

        if (courseId === 'all') {
            this.currentFilteredDocs = [...src];
        } else if (courseId === 'other') {
            this.currentFilteredDocs = src.filter(d => !d.course || d.course === 'other' || d.course === '');
        } else {
            this.currentFilteredDocs = src.filter(d => d.course == courseId);
        }

        this.pagination.currentPage = 1;
        this.renderPagedDocuments();
    },

    searchDocuments: function(k) {
        const term = k.toLowerCase().trim();
        let src = AppState.isViewingSaved ? AppState.allDocuments.filter(d=>AppState.currentUser?.savedDocs?.includes(d.id)) : AppState.allDocuments;
        this.currentFilteredDocs = term ? src.filter(d => d.name.toLowerCase().includes(term) || d.uploader.toLowerCase().includes(term)) : [...src];
        this.pagination.currentPage = 1;
        this.renderPagedDocuments();
    },
    filterByType: function(t) {
        let src = AppState.isViewingSaved ? AppState.allDocuments.filter(d=>AppState.currentUser?.savedDocs?.includes(d.id)) : AppState.allDocuments;
        this.currentFilteredDocs = t ? src.filter(d => d.type === t) : [...src];
        this.pagination.currentPage = 1;
        this.renderPagedDocuments();
    }
};

// ==================== PAGE MANAGEMENT ====================
const PageManager = {
    // H√†m ·∫©n t·∫•t c·∫£ (C·∫≠p nh·∫≠t ƒë·ªÉ t·∫Øt ch·∫ø ƒë·ªô full-mode)
    hideAllSections() {
        Object.values(DOM.sections).forEach(section => {
            if (section) section.style.display = 'none';
        });

        // ·∫®n section th∆∞ vi·ªán ri√™ng
        const libSection = document.getElementById('library-section');
        if (libSection) libSection.style.display = 'none';

        // QUAN TR·ªåNG: T·∫Øt ch·∫ø ƒë·ªô full m√†n h√¨nh (ƒë·ªÉ hi·ªán l·∫°i menu/sidebar khi v·ªÅ trang ch·ªß)
        document.body.classList.remove('full-mode');
    },

    showDashboard() {
        this.hideAllSections();
        if (DOM.sections.mainDashboard) DOM.sections.mainDashboard.style.display = 'block';
        // L·∫•y link Trang ch·ªß t·ª´ sidebar-left
        const sidebarHomeLink = document.querySelector('.sidebar-left .nav-menu a:first-child');
        UI.setActiveMenu(sidebarHomeLink);
        // Highlight header nav item
        UI.setActiveNavItem('nav-home');
    },

    // --- H√ÄM M·ªöI: D√†nh ri√™ng cho n√∫t T√†i li·ªáu tr√™n Thanh ƒëi·ªÅu h∆∞·ªõng ---
    // Trong PageManager
    showLibraryPage(menuItem) {
        this.hideAllSections();

        document.body.classList.add('full-mode');

        const libSection = document.getElementById('library-section');
        if (libSection) libSection.style.display = 'block';

        UI.setActiveMenu(menuItem || document.getElementById('nav-docs'));

        // Highlight header nav item
        UI.setActiveNavItem('nav-docs');

        // B·∫¨T CH·∫æ ƒê·ªò TH∆Ø VI·ªÜN
        DocumentManager.currentMode = 'library';
        DocumentManager.loadAllDocuments();
    },

    // H√†m c≈© cho Widget b√™n ph·∫£i (Gi·ªØ nguy√™n logic c≈©)
    showDocumentsPage(menuItem) {
        this.hideAllSections();
        if (DOM.sections.documentsSection) DOM.sections.documentsSection.style.display = 'block';

        UI.setActiveMenu(menuItem);

        // Thi·∫øt l·∫≠p ch·∫ø ƒë·ªô render c≈©
        DocumentManager.currentMode = 'normal'; // Ch·∫ø ƒë·ªô Widget (L∆∞·ªõi nh·ªè)
        DocumentManager.loadAllDocuments();
    },

    // Show saved documents page
    showSavedDocumentsPage(menuItem = null) {
        if (!AppState.currentUser) {
            Utils.showAlert("Th√¥ng b√°o", "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem t√†i li·ªáu ƒë√£ l∆∞u!", false);
            return;
        }

        this.hideAllSections();
        Utils.showElement(DOM.sections.documentsSection);

        AppState.isViewingSaved = true;
        UI.setActiveMenu(menuItem);
        UI.updatePageTitle(true);

        DocumentManager.renderSavedDocuments();
        DocumentManager.updateStats();

        // ‚úÖ ƒê·∫∂T TITLE CHO TRANG T√ÄI LI·ªÜU ƒê√É L∆ØU
        document.title = 'T√†i Li·ªáu ƒê√£ L∆∞u - Whalio';
    },

    // Show exams page
    showExamsPage(menuItem = null) {
        this.hideAllSections();
        // ·∫®n c√°c section kh√°c v√† hi·ªán exams-section
        const examSection = document.getElementById('exams-section');
        if (examSection) Utils.showElement(examSection);

        // N·∫øu kh√¥ng c√≥ menuItem, l·∫•y t·ª´ sidebar
        if (!menuItem) {
            const sidebarLinks = document.querySelectorAll('.sidebar-left .nav-menu a');
            menuItem = sidebarLinks[3]; // Thi online l√† ph·∫ßn t·ª≠ th·ª© 4 (index 3)
        }
        UI.setActiveMenu(menuItem);
        document.title = 'Thi Online - Whalio';

        // Load danh s√°ch ƒë·ªÅ
        ExamManager.renderExams();
    },

    // Show community page
    showCommunityPage(menuItem = null) {
        console.log('üéØ showCommunityPage called', menuItem);
        if (!AppState.currentUser) {
            Utils.showAlert("Th√¥ng b√°o", "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p c·ªông ƒë·ªìng!", false);
            return;
        }

        this.hideAllSections();
        const communitySection = document.getElementById('community-section');
        if (communitySection) {
            Utils.showElement(communitySection);
            console.log('‚úÖ Community section shown');
        } else {
            console.error('‚ùå Community section not found!');
        }

        // Clear all active nav items
        document.querySelectorAll('.nav-center .nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-menu a').forEach(el => el.classList.remove('active'));
        
        // Set active on community nav item
        const communityNavItem = document.querySelector('[data-tooltip="C·ªông ƒë·ªìng"]');
        if (communityNavItem) {
            communityNavItem.classList.add('active');
            console.log('‚úÖ Community nav item marked active');
        }

        document.title = 'C·ªông ƒê·ªìng - Whalio';

        // Initialize Community
        if (Community && Community.init) {
            console.log('üöÄ Calling Community.init()');
            Community.init();
        } else {
            console.error('‚ùå Community object not found!');
        }
    },

    // Show profile page
    showProfilePage() {
        this.hideAllSections();
        Utils.showElement(DOM.sections.profileSection);

        if (DOM.ui.userDropdown) {
            DOM.ui.userDropdown.classList.remove('active');
        }

        if (AppState.currentUser) {
            this.fillProfileData(AppState.currentUser);
        }

        // ‚úÖ ƒê·∫∂T TITLE CHO TRANG H·ªí S∆†
        document.title = 'H·ªì S∆° C√° Nh√¢n - Whalio';
    },

    // Fill profile data
    fillProfileData(user) {
        const largeAvatar = document.querySelector('.large-avatar');
        if (user.avatar && user.avatar.includes('/uploads/')) {
            largeAvatar.textContent = '';
            largeAvatar.style.backgroundImage = "url('" + user.avatar + "')";
            largeAvatar.style.backgroundSize = 'cover';
        } else {
            largeAvatar.textContent = user.avatar || 'U';
            largeAvatar.style.backgroundImage = 'none';
        }

        // Update profile fields
        const fields = {
            'p-fullname-1': user.fullName,
            'p-email-1': user.email || 'Ch∆∞a c·∫≠p nh·∫≠t email',
            'p-fullname-2': user.fullName,
            'p-username': user.username,
            'p-email-2': user.email || 'Ch∆∞a c·∫≠p nh·∫≠t',
            'p-phone': user.phone || 'Ch∆∞a c·∫≠p nh·∫≠t',
            'p-gender': user.gender || 'Ch∆∞a c·∫≠p nh·∫≠t',
            'p-birth': user.birthYear || 'Ch∆∞a c·∫≠p nh·∫≠t',
            'p-facebook': user.facebook || '#',
            'p-city': user.city || 'Ch∆∞a c·∫≠p nh·∫≠t',
            'p-school': user.school || 'Ch∆∞a c·∫≠p nh·∫≠t'
        };

        Object.entries(fields).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });
    }
};

// ==================== 10. STATS MANAGER (FIX L·ªñI TR√ôNG USER) ====================
const StatsManager = {
    timerInterval: null, // L∆∞u bi·∫øn interval ƒë·ªÉ c√≥ th·ªÉ d·ª´ng l·∫°i khi logout

    // H√†m t·∫°o key ri√™ng cho t·ª´ng user
    getUserKey(baseKey) {
        const username = AppState.currentUser ? AppState.currentUser.username : 'guest';
        return baseKey + '_' + username;
    },

    init() {
        this.stopStudyTimer(); // D·ª´ng timer c≈© n·∫øu c√≥
        this.checkStreak();
        this.startStudyTimer();
        this.updateUI();
    },

    // 1. Logic t√≠nh Streak (Chu·ªói ng√†y)
    checkStreak() {
        const keyStreak = this.getUserKey('whalio_streak');
        const keyLastVisit = this.getUserKey('whalio_last_visit');

        const today = new Date().toDateString();
        const lastVisit = localStorage.getItem(keyLastVisit);
        let currentStreak = parseInt(localStorage.getItem(keyStreak) || 0);

        if (!lastVisit) {
            currentStreak = 1;
        } else if (lastVisit !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            if (lastVisit === yesterday.toDateString()) {
                currentStreak++;
            } else {
                currentStreak = 1; // M·∫•t chu·ªói
            }
        }

        localStorage.setItem(keyStreak, currentStreak);
        localStorage.setItem(keyLastVisit, today);
    },

    // 2. Logic t√≠nh Gi·ªù h·ªçc
    startStudyTimer() {
        const keyTotalTime = this.getUserKey('whalio_total_minutes');

        // C·ª© m·ªói 1 ph√∫t th√¨ tƒÉng bi·∫øn ƒë·∫øm l√™n 1
        this.timerInterval = setInterval(() => {
            // Lu√¥n l·∫•y key m·ªõi nh·∫•t trong interval ph√≤ng tr∆∞·ªùng h·ª£p user ƒë·ªïi m√† kh√¥ng reload
            const currentKey = this.getUserKey('whalio_total_minutes');
            let totalMinutes = parseInt(localStorage.getItem(currentKey) || 0);
            totalMinutes++;
            localStorage.setItem(currentKey, totalMinutes);

            this.updateUI();
        }, 60000); // 60 gi√¢y
    },

    // H√†m d·ª´ng timer (G·ªçi khi logout)
    stopStudyTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    },

    // 3. C·∫≠p nh·∫≠t giao di·ªán
    updateUI() {
        const keyStreak = this.getUserKey('whalio_streak');
        const keyTotalTime = this.getUserKey('whalio_total_minutes');

        const streak = localStorage.getItem(keyStreak) || 1; // M·∫∑c ƒë·ªãnh l√† 1 n·∫øu ch∆∞a c√≥
        const totalMinutes = parseInt(localStorage.getItem(keyTotalTime) || 0);

        const hours = (totalMinutes / 60).toFixed(1);

        const statNumbers = document.querySelectorAll('.stat-num');
        if (statNumbers.length >= 2) {
            statNumbers[0].textContent = streak + ' N';
            statNumbers[1].textContent = hours + 'H';
        }
    }
};

// ==================== EXAM MANAGER (QU·∫¢N L√ù THI ONLINE) ====================
const ExamManager = {
    // D·ªØ li·ªáu gi·∫£ l·∫≠p (Mock Data)
    examsData: [
        {
            id: 1,
            title: "ƒê·ªÅ √¥n t·∫≠p Ph√°p Lu·∫≠t ƒê·∫°i C∆∞∆°ng - Ch∆∞∆°ng 1",
            desc: "T·ªïng h·ª£p c√°c c√¢u h·ªèi tr·∫Øc nghi·ªám v·ªÅ Nh√† n∆∞·ªõc v√† Ph√°p lu·∫≠t, ph√π h·ª£p √¥n thi gi·ªØa k·ª≥.",
            image: "./img/pldc-pic.png", // D√πng l·∫°i ·∫£nh b·∫°n ƒë√£ c√≥
            subject: "Ph√°p lu·∫≠t",
            questions: 40,
            time: "60 ph√∫t"
        },
        {
            id: 2,
            title: "Tr·∫Øc nghi·ªám T√¢m L√Ω H·ªçc - T√≠nh c√°ch & Kh√≠ ch·∫•t",
            desc: "B√†i ki·ªÉm tra ki·∫øn th·ª©c v·ªÅ c√°c lo·∫°i kh√≠ ch·∫•t, t√≠nh c√°ch con ng∆∞·ªùi v√† h√†nh vi ·ª©ng x·ª≠.",
            image: "./img/tlhdc-pic.png",
            subject: "T√¢m l√Ω",
            questions: 25,
            time: "30 ph√∫t"
        }
    ],

    // Render danh s√°ch ƒë·ªÅ thi
    renderExams(exams = this.examsData) {
        const container = document.getElementById('exams-list-container');
        if (!container) return;

        if (exams.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;"><div style="font-size: 48px; margin-bottom: 10px;">üîç</div><p>Kh√¥ng t√¨m th·∫•y ƒë·ªÅ thi n√†o ph√π h·ª£p.</p></div>';
            return;
        }

        container.innerHTML = exams.map(exam => 
            '<div class="exam-card" onclick="ExamRunner.openModeModal(' + exam.id + ')">' +
                '<div class="exam-thumb-wrapper">' +
                    '<img src="' + exam.image + '" alt="' + exam.title + '" class="exam-thumb" onerror="this.src=\'https://via.placeholder.com/300x200?text=Exam\'">' +
                    '<span class="exam-tag">' + exam.subject + '</span>' +
                '</div>' +
                '<div class="exam-content">' +
                    '<h3 class="exam-title">' + exam.title + '</h3>' +
                    '<p class="exam-desc">' + exam.desc + '</p>' +
                    '<div class="exam-meta">' +
                        '<div>' +
                            '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg> ' +
                            exam.questions + ' c√¢u' +
                        '</div>' +
                        '<div>' +
                            '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> ' +
                            exam.time +
                        '</div>' +
                    '</div>' +
                    '<div class="btn-start-exam">L√†m b√†i ngay ‚ûú</div>' +
                '</div>' +
            '</div>'
        ).join('');
    },

    // T√¨m ki·∫øm ƒë·ªÅ thi
    searchExams(keyword) {
        const term = keyword.toLowerCase().trim();
        const filtered = this.examsData.filter(exam =>
            exam.title.toLowerCase().includes(term) ||
            exam.desc.toLowerCase().includes(term)
        );
        this.renderExams(filtered);
    },

    // L·ªçc theo m√¥n h·ªçc
    filterBySubject(subject) {
        if (!subject) {
            this.renderExams(this.examsData);
            return;
        }
        const filtered = this.examsData.filter(exam => exam.subject === subject);
        this.renderExams(filtered);
    }
};

// ƒê∆∞a ra global ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c
window.ExamManager = ExamManager;

// ==================== EVENT HANDLERS ====================
const EventHandlers = {
    // Handle login form submission
    async handleLogin(event) {
        event.preventDefault();

        const username = document.querySelector('#loginForm input[type="text"]').value.trim();
        const password = document.getElementById('passwordInput').value.trim();
        const btnSubmit = document.querySelector('.btn-submit-login');

        if (!username || !password) {
            Utils.showAlert("Th√¥ng b√°o", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!", false);
            return;
        }

        Utils.setButtonLoading(btnSubmit, true);

        const result = await Auth.login(username, password);

        if (result.success) {
            AppState.saveUser(result.user);
            UI.showUserInterface(result.user);
            ModalManager.close('login');
            Utils.showAlert("Th√†nh c√¥ng!", 'Xin ch√†o ' + result.user.fullName + '! üëã', true);

            // Load documents for the user
            DocumentManager.loadAllDocuments();

            StatsManager.init();
        } else {
            Utils.showAlert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", result.message, false);
        }

        Utils.setButtonLoading(btnSubmit, false);
    },

    // Handle document upload
    // Handle document upload
    async handleUploadDocument(event) {
        event.preventDefault();

        const form = event.target;
        const fileInput = document.getElementById('docFile');
        const nameInput = document.getElementById('docName');
        const btn = form.querySelector('button[type="submit"]');

        if (!fileInput.files.length) {
            Utils.showAlert("Th√¥ng b√°o", "Vui l√≤ng ch·ªçn file!", false);
            return;
        }

        const file = fileInput.files[0];
        const fileName = file.name.toLowerCase();
        let finalType = 'other'; // M·∫∑c ƒë·ªãnh l√† other

        // --- LOGIC: T·ª∞ ƒê·ªòNG √âP KI·ªÇU D·ª∞A TR√äN ƒêU√îI FILE (IGNORE USER SELECTION) ---
        if (fileName.endsWith('.pdf')) {
            finalType = 'pdf';
        } else if (fileName.includes('.doc') || fileName.includes('.docx')) {
            finalType = 'word';
        } else if (fileName.includes('.xls') || fileName.includes('.xlsx') || fileName.includes('.csv')) {
            finalType = 'excel';
        } else if (fileName.includes('.ppt') || fileName.includes('.pptx')) {
            finalType = 'ppt';
        } else if (/\.(jpg|jpeg|png|gif|webp)$/.test(fileName)) {
            finalType = 'image';
        }
        // -----------------------------------------------------------------------

        const formData = new FormData();
        formData.append('file', file);
        formData.append('name', nameInput.value);
        // QUAN TR·ªåNG: Thay v√¨ l·∫•y t·ª´ dropdown, ta l·∫•y t·ª´ bi·∫øn finalType ƒë√£ t√≠nh to√°n ·ªü tr√™n
        formData.append('type', finalType);

        // Add selected course
        const courseSelect = document.getElementById('docCourse');
        const selectedCourse = courseSelect.value;
        formData.append('course', selectedCourse);

        formData.append('uploader', AppState.currentUser.fullName);

        Utils.setButtonLoading(btn, true);

        const result = await DocumentManager.uploadDocument(formData);

        Utils.setButtonLoading(btn, false);

        if (result.success) {
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            Utils.showAlert("Th√†nh c√¥ng!", "T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n!", true);
            
            // Reset form ngay l·∫≠p t·ª©c
            form.reset();
            
            // Add new document to the list
            AppState.allDocuments.unshift(result.document);
            
            // C·∫≠p nh·∫≠t filtered docs
            if (AppState.isViewingSaved) {
                DocumentManager.currentFilteredDocs = AppState.allDocuments.filter(doc => 
                    AppState.currentUser?.savedDocs?.includes(doc.id)
                );
            } else {
                DocumentManager.currentFilteredDocs = [...AppState.allDocuments];
            }
            
            // Reset v·ªÅ trang 1 v√† render l·∫°i
            DocumentManager.pagination.currentPage = 1;
            DocumentManager.renderPagedDocuments();
            DocumentManager.updateStats();
            
            // C·∫≠p nh·∫≠t ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
            RecentActivity.loadActivities();
            
            // ƒê√≥ng modal sau 300ms ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y th√¥ng b√°o
            setTimeout(() => {
                const uploadModal = document.getElementById('uploadDocModal');
                if (uploadModal) {
                    uploadModal.classList.remove('active');
                    uploadModal.style.display = 'none';
                }
            }, 300);
        } else {
            Utils.showAlert("L·ªói", result.message || "Kh√¥ng th·ªÉ t·∫£i l√™n!", false);
        }
    },

    // Handle logout confirmation
    confirmLogout() {
        const btn = document.querySelector('#logoutModal button:last-child');
        btn.textContent = "ƒêang ƒëƒÉng xu·∫•t...";
        btn.disabled = true;

        setTimeout(() => {
            Auth.logout();
        }, 500);
    },

    // Setup menu events
    setupMenuEvents() {
        // Dashboard menu
        const dashboardMenu = document.querySelector('.nav-center .nav-item[data-tooltip="Trang ch·ªß"]');
        if (dashboardMenu) {
            dashboardMenu.addEventListener('click', (e) => {
                e.preventDefault();
                PageManager.showDashboard();
            });
        }

        // Left sidebar menus
        const leftMenus = document.querySelectorAll('.nav-menu a');

        // Dashboard
        if (leftMenus[0]) {
            leftMenus[0].addEventListener('click', (e) => {
                e.preventDefault();
                PageManager.showDashboard();
            });
        }

        // All Documents
        if (leftMenus[1]) {
            leftMenus[1].addEventListener('click', (e) => {
                e.preventDefault();
                PageManager.showDocumentsPage(e.target);
            });
        }

        // Saved Documents
        if (leftMenus[2]) {
            leftMenus[2].addEventListener('click', (e) => {
                e.preventDefault();
                PageManager.showSavedDocumentsPage(e.target);
            });
        }

        if (leftMenus[3]) {
            leftMenus[3].addEventListener('click', (e) => {
                e.preventDefault();
                PageManager.showExamsPage(e.target);
            });
        }

        // Profile dropdown toggle
        {
            document.addEventListener('click', (e) => {
                // N·∫øu click v√†o Avatar (n√∫t k√≠ch ho·∫°t) th√¨ D·ª™NG L·∫†I, ƒë·ª´ng ƒë√≥ng menu
                // (V√¨ h√†m toggleUserMenu ƒë√£ lo vi·ªác m·ªü/ƒë√≥ng r·ªìi)
                if (e.target.closest('.nav-avatar') || e.target.closest('.avatar-wrapper')) {
                    return;
                }

                // Ch·ªâ ƒë√≥ng khi click ra ngo√†i menu
                if (DOM.ui.userDropdown && !DOM.ui.userDropdown.contains(e.target)) {
                    DOM.ui.userDropdown.classList.remove('active');
                }
            });
        }
    },

    // Setup form submissions
    setupFormSubmissions() {
        // Login form
        const loginForm = document.getElementById('loginForm');
        if (loginForm && !loginForm.dataset.listenerAdded) {
            loginForm.dataset.listenerAdded = 'true';
            loginForm.addEventListener('submit', this.handleLogin.bind(this));
        }

        // Upload form
        const uploadForm = document.querySelector('#uploadDocModal form');
        if (uploadForm && !uploadForm.dataset.listenerAdded) {
            uploadForm.dataset.listenerAdded = 'true';
            uploadForm.addEventListener('submit', this.handleUploadDocument.bind(this));
        }

        const docFileInput = document.getElementById('docFile');
        if (docFileInput) {
            docFileInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const fileName = this.files[0].name.toLowerCase();
                    const typeSelect = document.getElementById('docType');
                    const nameInput = document.getElementById('docName');

                    // 1. Ti·ªán tay ƒëi·ªÅn lu√¥n t√™n file v√†o √¥ nh·∫≠p t√™n (n·∫øu √¥ t√™n ƒëang tr·ªëng)
                    // Gi√∫p ng∆∞·ªùi d√πng ƒë·ª° ph·∫£i g√µ l·∫°i t√™n
                    if (!nameInput.value) {
                        // L·∫•y t√™n file b·ªè ƒëi ph·∫ßn ƒëu√¥i (v√≠ d·ª•: Bai-tap.docx -> Bai-tap)
                        nameInput.value = this.files[0].name.replace(/\.[^/.]+$/, "");
                    }

                    // 2. Logic t·ª± ƒë·ªông ch·ªçn lo·∫°i file d·ª±a tr√™n ƒëu√¥i
                    if (fileName.endsWith('.pdf')) {
                        typeSelect.value = 'pdf';
                    }
                    else if (fileName.includes('.doc') || fileName.includes('.docx')) {
                        typeSelect.value = 'word';
                    }
                    else if (fileName.includes('.xls') || fileName.includes('.xlsx') || fileName.includes('.csv')) {
                        // L∆∞u √Ω: C·∫ßn th√™m option Excel v√†o HTML n·∫øu ch∆∞a c√≥
                        // N·∫øu HTML ch∆∞a c√≥ value='excel' th√¨ n√≥ s·∫Ω nh·∫£y v·ªÅ m·∫∑c ƒë·ªãnh
                        // Ki·ªÉm tra l·∫°i file index.html d√≤ng 750 xem c√≥ option excel ch∆∞a nh√©
                        typeSelect.value = 'excel';
                    }
                    else if (fileName.includes('.ppt') || fileName.includes('.pptx')) {
                        typeSelect.value = 'ppt';
                    }
                    else if (/\.(jpg|jpeg|png|gif|webp)$/.test(fileName)) {
                        typeSelect.value = 'image';
                    }
                    else {
                        typeSelect.value = 'other';
                    }
                }
            });
        }
    }
};

// ==================== INITIALIZATION ====================

// Module: Qu·∫£n l√Ω ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
const RecentActivity = {
    async loadActivities() {
        try {
            const response = await fetch('/api/recent-activities');
            const data = await response.json();
            
            if (data.success) {
                this.renderActivities(data.activities, data.count);
            }
        } catch (error) {
            console.error('Load activities error:', error);
        }
    },

    renderActivities(activities, count) {
        const container = document.querySelector('.activity-list');
        const badge = document.querySelector('.recent-activity .badge-count');
        
        if (!container) return;
        
        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        if (badge) {
            badge.textContent = count;
        }
        
        if (activities.length === 0) {
            container.innerHTML = '<li style="text-align: center; color: #6b7280; padding: 20px;">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</li>';
            return;
        }
        
        // L∆∞u t·∫•t c·∫£ activities v√†o bi·∫øn to√†n c·ª•c
        this.allActivities = activities;
        this.isShowingAll = false;
        
        // Hi·ªÉn th·ªã 4 ho·∫°t ƒë·ªông ƒë·∫ßu ti√™n
        this.renderActivityList(activities.slice(0, 4));
        
        // Th√™m n√∫t "Xem th√™m" n·∫øu c√≥ nhi·ªÅu h∆°n 4 ho·∫°t ƒë·ªông
        if (activities.length > 4) {
            const viewMoreBtn = document.createElement('li');
            viewMoreBtn.style.textAlign = 'center';
            viewMoreBtn.style.padding = '10px';
            viewMoreBtn.innerHTML = '<button onclick="RecentActivity.toggleViewAll()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.2s;" onmouseover="this.style.background=\'#4f46e5\'" onmouseout="this.style.background=\'#6366f1\'">Xem th√™m (' + (activities.length - 4) + ')</button>';
            container.appendChild(viewMoreBtn);
        }
    },
    
    renderActivityList(activities) {
        const container = document.querySelector('.activity-list');
        if (!container) return;
        
        container.innerHTML = activities.map(activity => {
            const bgColor = this.getAvatarColor(activity.type);
            const timeAgo = this.getTimeAgo(activity.time);
            
            const avatarHtml = activity.userAvatar 
                ? '<img src="' + activity.userAvatar + '" class="avatar-small" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="avatar">'
                : '<div class="avatar-small ' + bgColor + '">' + activity.avatar + '</div>';
            
            return '<li>' + avatarHtml + '<div class="activity-info"><p><strong>' + activity.user + '</strong> ' + activity.action + '</p><a href="' + activity.link + '" class="file-link">' + activity.target + '</a><span class="time-ago">' + timeAgo + '</span></div></li>';
        }).join('');
    },
    
    toggleViewAll() {
        const container = document.querySelector('.activity-list');
        if (!container) return;
        
        this.isShowingAll = !this.isShowingAll;
        
        if (this.isShowingAll) {
            // Hi·ªÉn th·ªã t·∫•t c·∫£
            this.renderActivityList(this.allActivities);
            
            // Th√™m n√∫t "Thu g·ªçn"
            const collapseBtn = document.createElement('li');
            collapseBtn.style.textAlign = 'center';
            collapseBtn.style.padding = '10px';
            collapseBtn.innerHTML = '<button onclick="RecentActivity.toggleViewAll()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.2s;" onmouseover="this.style.background=\'#4b5563\'" onmouseout="this.style.background=\'#6b7280\'">Thu g·ªçn</button>';
            container.appendChild(collapseBtn);
        } else {
            // Hi·ªÉn th·ªã 4 ho·∫°t ƒë·ªông ƒë·∫ßu ti√™n
            this.renderActivityList(this.allActivities.slice(0, 4));
            
            // Th√™m n√∫t "Xem th√™m"
            const viewMoreBtn = document.createElement('li');
            viewMoreBtn.style.textAlign = 'center';
            viewMoreBtn.style.padding = '10px';
            viewMoreBtn.innerHTML = '<button onclick="RecentActivity.toggleViewAll()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.2s;" onmouseover="this.style.background=\'#4f46e5\'" onmouseout="this.style.background=\'#6366f1\'">Xem th√™m (' + (this.allActivities.length - 4) + ')</button>';
            container.appendChild(viewMoreBtn);
        }
    },

    getAvatarColor(type) {
        const colors = {
            'upload': '',
            'comment': 'bg-green'
        };
        return colors[type] || 'bg-purple';
    },

    getTimeAgo(dateString) {
        const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
        
        if (seconds < 60) return 'V·ª´a xong';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' ph√∫t tr∆∞·ªõc';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' gi·ªù tr∆∞·ªõc';
        return Math.floor(seconds / 86400) + ' ng√†y tr∆∞·ªõc';
    }
};

function initializeApp() {
    // Initialize state
    const isLoggedIn = AppState.init();

    // Show appropriate interface
    if (isLoggedIn) {
        UI.showUserInterface(AppState.currentUser);
        PageManager.showDashboard();
    } else {
        UI.showGuestInterface();
    }

    // Load documents and courses
    DocumentManager.loadAllDocuments();
    DocumentManager.loadCourses();

    // Setup event listeners
    ModalManager.setupCloseListeners();
    EventHandlers.setupMenuEvents();
    EventHandlers.setupFormSubmissions();

    StudyTimer.init();

    StatsManager.init();
    
    // Load ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
    if (isLoggedIn) {
        RecentActivity.loadActivities();
    }

    console.log('‚úÖ study.js ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng!');
}

// ==================== GLOBAL EXPORTS ====================
// Make functions available globally for HTML onclick handlers
window.App = {
    // Modal functions
    openLoginModal: () => ModalManager.open('login'),
    closeLoginModal: () => ModalManager.close('login'),
    openRegisterModal: () => ModalManager.open('register'),
    closeRegisterModal: () => ModalManager.close('register'),
    openForgotPasswordModal: () => {
        ModalManager.close('login');
        ModalManager.open('forgot');
    },
    closeForgotPasswordModal: () => ModalManager.close('forgot'),
    openUploadDocModal: () => ModalManager.open('uploadDoc'),
    closeUploadDocModal: () => ModalManager.close('uploadDoc'),
    openEditProfileModal: () => ModalManager.open('editProfile'),
    closeEditProfileModal: () => ModalManager.close('editProfile'),
    openChangePassModal: () => ModalManager.open('changePass'),
    closeChangePassModal: () => ModalManager.close('changePass'),
    openLogoutModal: () => ModalManager.open('logout'),
    closeLogoutModal: () => ModalManager.close('logout'),

    // Navigation functions
    showDashboard: () => PageManager.showDashboard(),
    showDocumentsPage: (e) => {
        if (e) e.preventDefault();
        PageManager.showDocumentsPage(e?.target);
    },
    showSavedDocumentsPage: (e) => {
        if (e) e.preventDefault();
        PageManager.showSavedDocumentsPage(e?.target);
    },
    showProfilePage: () => PageManager.showProfilePage(),

    // Action functions
    toggleSaveDocument: (docId) => DocumentManager.toggleSave(docId),
    confirmLogoutAction: () => EventHandlers.confirmLogout(),
    closeCustomAlert: () => Utils.closeAlert(),

    // Utility functions
    toggleUserMenu: () => {
        if (DOM.ui.userDropdown) {
            DOM.ui.userDropdown.classList.toggle('active');
        }
    },
    switchToLoginFromForgot: () => {
        ModalManager.close('forgot');
        ModalManager.open('login');
    },
    switchToRegister: () => {
        ModalManager.close('login');
        ModalManager.open('register');
    },
    switchToLogin: () => {
        ModalManager.close('register');
        ModalManager.open('login');
    }
};

// ==================== COMPATIBILITY WITH OLD HTML ====================
// T·∫°o alias cho c√°c h√†m c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi HTML
window.openLoginModal = () => ModalManager.open('login');
window.closeLoginModal = () => ModalManager.close('login');
window.handleLogout = () => ModalManager.open('logout');

// Export RecentActivity cho community.js
window.RecentActivity = RecentActivity;
window.closeLogoutModal = () => ModalManager.close('logout');
window.confirmLogoutAction = () => EventHandlers.confirmLogout();
window.openUploadDocModal = () => {
    DocumentManager.populateCourseDropdown();
    ModalManager.open('uploadDoc');
};
window.closeUploadDocModal = () => ModalManager.close('uploadDoc');
window.showProfilePage = () => PageManager.showProfilePage();
window.showDashboard = () => PageManager.showDashboard();
window.showAllDocsPage = (el) => {
    if (el) el.preventDefault();
    PageManager.showDocumentsPage(el?.target);
};
window.showDocumentsPage = (el) => {
    if (el) el.preventDefault();
    PageManager.showDocumentsPage(el?.target);
};
window.showSavedDocumentsPage = (el) => {
    if (el) el.preventDefault();
    PageManager.showSavedDocumentsPage(el?.target);
};
window.showCommunityPage = (el) => {
    console.log('üîó window.showCommunityPage called', el);
    if (el) el.preventDefault();
    PageManager.showCommunityPage(el?.target);
};
window.PageManager = PageManager;
window.toggleSaveDocument = (docId) => DocumentManager.toggleSave(docId);
window.searchDocuments = (keyword) => DocumentManager.searchDocuments(keyword);
window.filterByType = (type) => DocumentManager.filterByType(type);
window.loadDocuments = () => DocumentManager.loadAllDocuments();
window.closeCustomAlert = () => Utils.closeAlert();
window.toggleUserMenu = () => {
    if (DOM.ui.userDropdown) {
        DOM.ui.userDropdown.classList.toggle('active');
    }
};
window.openForgotPasswordModal = () => {
    ModalManager.close('login');
    ModalManager.open('forgot');
};
window.closeForgotPasswordModal = () => ModalManager.close('forgot');
window.switchToLoginFromForgot = () => {
    ModalManager.close('forgot');
    ModalManager.open('login');
};
window.switchToRegister = () => {
    ModalManager.close('login');
    ModalManager.open('register');
};
window.switchToLogin = () => {
    ModalManager.close('register');
    ModalManager.open('login');
};
window.closeRegisterModal = () => ModalManager.close('register');
window.openEditProfileModal = () => ModalManager.open('editProfile');
window.closeEditProfileModal = () => ModalManager.close('editProfile');
window.openChangePassModal = () => ModalManager.open('changePass');
window.closeChangePassModal = () => ModalManager.close('changePass');

// ==================== START APPLICATION ====================
window.addEventListener('DOMContentLoaded', initializeApp);

// ==================== B·ªî SUNG T√çNH NƒÇNG S·ª¨A H·ªí S∆† (D√°n v√†o cu·ªëi file) ====================

// 1. H√†m t·ª± ƒë·ªông ƒëi·ªÅn d·ªØ li·ªáu c≈© v√†o form khi m·ªü Modal
function fillEditProfileForm() {
    const user = AppState.currentUser;
    if (!user) return;

    // Helper: T√¨m v√† g√°n gi√° tr·ªã n·∫øu element t·ªìn t·∫°i
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val || '';
    };

    // ƒêi·ªÅn d·ªØ li·ªáu v√†o 10 tr∆∞·ªùng
    setVal('edit-username', user.username); // Readonly
    setVal('edit-fullname', user.fullName);
    setVal('edit-email', user.email);
    setVal('edit-phone', user.phone);
    setVal('edit-gender', user.gender || 'Nam'); // M·∫∑c ƒë·ªãnh l√† Nam n·∫øu ch∆∞a c√≥
    setVal('edit-birth', user.birthYear);
    setVal('edit-school', user.school);
    setVal('edit-city', user.city);
    setVal('edit-facebook', user.facebook);

    // X·ª≠ l√Ω hi·ªÉn th·ªã Avatar preview
    const previewImg = document.getElementById('preview-img');
    const previewText = document.getElementById('preview-text');

    if (previewImg && previewText) {
        if (user.avatar && user.avatar.includes('/uploads/')) {
            previewImg.src = user.avatar;
            previewImg.style.display = 'block';
            previewText.style.display = 'none';
        } else {
            previewImg.style.display = 'none';
            previewText.style.display = 'block';
            previewText.textContent = user.fullName ? user.fullName.charAt(0).toUpperCase() : 'U';
        }
    }
}

// 2. H√†m x·ª≠ l√Ω khi b·∫•m n√∫t "L∆∞u thay ƒë·ªïi"
// ==================== C·∫¨P NH·∫¨T H·ªí S∆† (PHI√äN B·∫¢N G·ªåI API SERVER) ====================

window.handleUpdateProfile = async function (event) {
    event.preventDefault(); // Ch·∫∑n t·∫£i l·∫°i trang

    const btnSubmit = event.target.querySelector('button[type="submit"]');
    Utils.setButtonLoading(btnSubmit, true);

    // Helper: L·∫•y gi√° tr·ªã t·ª´ input
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };

    // 1. Thu th·∫≠p d·ªØ li·ªáu t·ª´ Form
    // QUAN TR·ªåNG: Server c·∫ßn "username" ƒë·ªÉ bi·∫øt ƒëang s·ª≠a ai
    const profileData = {
        username: AppState.currentUser.username,
        fullName: getValue('edit-fullname'),
        email: getValue('edit-email'),
        phone: getValue('edit-phone'),
        gender: getValue('edit-gender'),
        birthYear: getValue('edit-birth'),
        school: getValue('edit-school'),
        city: getValue('edit-city'),
        facebook: getValue('edit-facebook')
    };

    try {
        // 2. G·ª≠i d·ªØ li·ªáu l√™n Server Node.js
        // API n√†y ƒë√£ ƒë∆∞·ª£c vi·∫øt s·∫µn trong file server.js c·ªßa b·∫°n
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profileData)
        });

        const result = await response.json();

        if (result.success) {
            // 3. N·∫øu Server b√°o th√†nh c√¥ng (ƒë√£ ghi v√†o json)

            // C·∫≠p nh·∫≠t l·∫°i AppState (B·ªô nh·ªõ tr√¨nh duy·ªát) ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi Server
            // Gi·ªØ l·∫°i c√°c th√¥ng tin c≈© (nh∆∞ id, savedDocs, avatar) v√† ghi ƒë√® th√¥ng tin m·ªõi
            const newUserState = { ...AppState.currentUser, ...result.user };
            AppState.saveUser(newUserState);

            // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
            UI.showUserInterface(newUserState);
            if (PageManager.fillProfileData) {
                PageManager.fillProfileData(newUserState);
            }

            Utils.showAlert("Th√†nh c√¥ng", "H·ªì s∆° ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng!", true);
            ModalManager.close('editProfile');
        } else {
            // N·∫øu Server b√°o l·ªói
            throw new Error(result.message);
        }

    } catch (error) {
        console.error("L·ªói c·∫≠p nh·∫≠t:", error);
        Utils.showAlert("L·ªói", error.message || "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server", false);
    } finally {
        Utils.setButtonLoading(btnSubmit, false);
    }
};

// ƒê·∫£m b·∫£o Window nh·∫≠n di·ªán h√†m
if (window.App) {
    window.App.handleUpdateProfile = window.handleUpdateProfile;
}
// 3. GHI ƒê√à l·ªánh m·ªü Modal c≈© ƒë·ªÉ n√≥ g·ªçi h√†m fill d·ªØ li·ªáu tr∆∞·ªõc khi m·ªü
window.openEditProfileModal = () => {
    fillEditProfileForm(); // <--- ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o tr∆∞·ªõc
    ModalManager.open('editProfile'); // <--- Sau ƒë√≥ m·ªõi m·ªü modal l√™n
};

// C·∫≠p nh·∫≠t c·∫£ trong window.App ƒë·ªÉ ƒë·ªìng b·ªô
if (window.App) {
    window.App.openEditProfileModal = window.openEditProfileModal;
}

// 4. H√†m x·ª≠ l√Ω xem tr∆∞·ªõc ·∫£nh khi ch·ªçn file (Avatar)
window.handleAvatarPreview = function () {
    const fileInput = document.getElementById('avatar-input');
    const previewImg = document.getElementById('preview-img');
    const previewText = document.getElementById('preview-text');

    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            previewText.style.display = 'none';
        };
        reader.readAsDataURL(fileInput.files[0]);
    }
};

// ==================== T√çNH NƒÇNG ƒê·ªîI M·∫¨T KH·∫®U (PHI√äN B·∫¢N G·ªåI API NODE.JS) ====================

window.handleChangePassword = async function (event) {
    event.preventDefault(); // Ch·∫∑n form t·∫£i l·∫°i trang

    // 1. L·∫•y d·ªØ li·ªáu t·ª´ √¥ nh·∫≠p
    const oldPass = document.getElementById('old-pass').value.trim();
    const newPass = document.getElementById('new-pass').value.trim();
    const confirmPass = document.getElementById('confirm-new-pass').value.trim();
    const btnSubmit = event.target.querySelector('button[type="submit"]');

    // 2. Validate (Ki·ªÉm tra d·ªØ li·ªáu)
    if (!oldPass || !newPass || !confirmPass) {
        Utils.showAlert("L·ªói", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng!", false);
        return;
    }

    if (newPass !== confirmPass) {
        Utils.showAlert("L·ªói", "M·∫≠t kh·∫©u m·ªõi x√°c nh·∫≠n kh√¥ng kh·ªõp!", false);
        return;
    }

    if (newPass.length < 6) {
        Utils.showAlert("L·ªói", "M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", false);
        return;
    }

    // 3. G·ª≠i y√™u c·∫ßu l√™n Server Node.js
    Utils.setButtonLoading(btnSubmit, true);

    try {
        // G·ªçi API /api/change-password (ƒë√£ c√≥ trong server.js c·ªßa b·∫°n)
        const response = await fetch('/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: AppState.currentUser.username, // L·∫•y username t·ª´ user ƒëang ƒëƒÉng nh·∫≠p
                oldPass: oldPass,
                newPass: newPass
            })
        });

        const result = await response.json();

        if (result.success) {
            // A. ƒê·ªïi th√†nh c√¥ng
            Utils.showAlert("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", true);
            ModalManager.close('changePass');
            event.target.reset(); // X√≥a tr·∫Øng form

            // C·∫≠p nh·∫≠t l·∫°i m·∫≠t kh·∫©u trong LocalStorage client ƒë·ªÉ tr√°nh b·ªã l·ªói n·∫øu ch∆∞a logout ngay
            if (AppState.currentUser) {
                AppState.currentUser.password = newPass;
                AppState.saveUser(AppState.currentUser);
            }

            // T·ª± ƒë·ªông ƒëƒÉng xu·∫•t sau 1.5 gi√¢y ƒë·ªÉ b·∫£o m·∫≠t
            setTimeout(() => {
                Auth.logout();
            }, 1500);

        } else {
            // B. ƒê·ªïi th·∫•t b·∫°i (VD: Sai m·∫≠t kh·∫©u c≈©)
            Utils.showAlert("Th·∫•t b·∫°i", result.message || "C√≥ l·ªói x·∫£y ra", false);
        }

    } catch (error) {
        console.error("L·ªói k·∫øt n·ªëi:", error);
        Utils.showAlert("L·ªói m·∫°ng", "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server!", false);
    } finally {
        Utils.setButtonLoading(btnSubmit, false);
    }
};

// ƒê·∫£m b·∫£o window nh·∫≠n di·ªán h√†m n√†y
if (window.App) {
    window.App.handleChangePassword = window.handleChangePassword;
}

// ==================== T√çNH NƒÇNG ƒêƒÇNG K√ù T√ÄI KHO·∫¢N ====================

window.handleRegister = async function (event) {
    event.preventDefault(); // Ch·∫∑n t·∫£i l·∫°i trang

    const btnSubmit = event.target.querySelector('button[type="submit"]');
    Utils.setButtonLoading(btnSubmit, true);

    // 1. L·∫•y d·ªØ li·ªáu t·ª´ form HTML
    const fullName = document.getElementById('regFullname').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const confirmPassword = document.getElementById('regConfirmPassword').value.trim();

    // 2. Ki·ªÉm tra d·ªØ li·ªáu (Validate)
    if (!fullName || !email || !username || !password || !confirmPassword) {
        Utils.showAlert("L·ªói", "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", false);
        Utils.setButtonLoading(btnSubmit, false);
        return;
    }

    if (password !== confirmPassword) {
        Utils.showAlert("L·ªói", "M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!", false);
        Utils.setButtonLoading(btnSubmit, false);
        return;
    }

    if (password.length < 6) {
        Utils.showAlert("L·ªói", "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", false);
        Utils.setButtonLoading(btnSubmit, false);
        return;
    }

    // 3. G·ª≠i d·ªØ li·ªáu l√™n Server Node.js
    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fullName: fullName,
                email: email,
                username: username,
                password: password
            })
        });

        const result = await response.json();

        if (result.success) {
            // ƒêƒÉng k√Ω th√†nh c√¥ng -> T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p lu√¥n
            AppState.saveUser(result.user);
            UI.showUserInterface(result.user);

            // ƒê√≥ng modal ƒëƒÉng k√Ω
            ModalManager.close('register');

            // Hi·ªán th√¥ng b√°o ch√†o m·ª´ng
            Utils.showAlert("Th√†nh c√¥ng! üéâ", "Ch√†o m·ª´ng b·∫°n gia nh·∫≠p Whalio Group!", true);

            // X√≥a tr·∫Øng form
            event.target.reset();

            // T·∫£i danh s√°ch t√†i li·ªáu (ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√£ l∆∞u n·∫øu c√≥)
            DocumentManager.loadAllDocuments();
        } else {
            // Server b√°o l·ªói (VD: T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i)
            Utils.showAlert("ƒêƒÉng k√Ω th·∫•t b·∫°i", result.message, false);
        }

    } catch (error) {
        console.error("L·ªói ƒëƒÉng k√Ω:", error);
        Utils.showAlert("L·ªói m·∫°ng", "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server!", false);
    } finally {
        Utils.setButtonLoading(btnSubmit, false);
    }
};

// ƒê·∫£m b·∫£o window nh·∫≠n di·ªán ƒë∆∞·ª£c h√†m n√†y
if (window.App) {
    window.App.handleRegister = window.handleRegister;
}

// --- B·ªî SUNG H√ÄM X√ìA T√ÄI LI·ªÜU V√ÄO CU·ªêI FILE study.js ---

DocumentManager.deleteDocument = async function (docId) {
    // Ki·ªÉm tra quy·ªÅn tr∆∞·ªõc ti√™n
    if (!AppState.currentUser || AppState.currentUser.role !== 'admin') {
        Utils.showAlert("L·ªói", "Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ x√≥a t√†i li·ªáu!", false);
        return;
    }

    if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO ADMIN:\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn t√†i li·ªáu n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
        return;
    }

    try {
        const response = await fetch('/api/delete-document', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                docId: docId,
                username: AppState.currentUser.username // G·ª≠i k√®m username ƒë·ªÉ server check quy·ªÅn
            })
        });

        const result = await response.json();

        if (result.success) {
            Utils.showAlert("ƒê√£ x√≥a", "T√†i li·ªáu ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn! üóëÔ∏è", true);
            // Reload danh s√°ch
            this.loadAllDocuments();
        } else {
            Utils.showAlert("L·ªói", result.message, false);
        }
    } catch (error) {
        console.error(error);
        Utils.showAlert("L·ªói", "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server", false);
    }
}

// ==================== FOCUS MODE LOGIC (FLIP CLOCK EDITION) ====================

const StudyTimer = {
    interval: null,
    totalSeconds: 25 * 60,
    remainingSeconds: 25 * 60,
    isRunning: false,
    elements: {},

    init() {
        this.elements = {
            overlay: document.getElementById('study-focus-overlay'),
            hourTop: document.querySelector('#f-hours .top'),
            hourBottom: document.querySelector('#f-hours .bottom'),
            minuteTop: document.querySelector('#f-minutes .top'),
            minuteBottom: document.querySelector('#f-minutes .bottom'),
            secondTop: document.querySelector('#f-seconds .top'),
            secondBottom: document.querySelector('#f-seconds .bottom'),
            startBtn: document.getElementById('btn-start-focus'),
            pauseBtn: document.getElementById('btn-pause-focus'),
            resetBtn: document.getElementById('btn-reset-focus'),
            closeBtn: document.getElementById('btn-close-focus')
        };
    },

    updateDisplay() {
        const hours = Math.floor(this.remainingSeconds / 3600);
        const minutes = Math.floor((this.remainingSeconds % 3600) / 60);
        const seconds = this.remainingSeconds % 60;

        if (this.elements.hourTop) this.elements.hourTop.textContent = String(hours).padStart(2, '0');
        if (this.elements.hourBottom) this.elements.hourBottom.textContent = String(hours).padStart(2, '0');
        if (this.elements.minuteTop) this.elements.minuteTop.textContent = String(minutes).padStart(2, '0');
        if (this.elements.minuteBottom) this.elements.minuteBottom.textContent = String(minutes).padStart(2, '0');
        if (this.elements.secondTop) this.elements.secondTop.textContent = String(seconds).padStart(2, '0');
        if (this.elements.secondBottom) this.elements.secondBottom.textContent = String(seconds).padStart(2, '0');
    },

    start() {
        if (this.isRunning) return;
        this.isRunning = true;
        
        this.interval = setInterval(() => {
            if (this.remainingSeconds > 0) {
                this.remainingSeconds--;
                this.updateDisplay();
            } else {
                this.pause();
                alert('‚è∞ H·∫øt gi·ªù! B·∫°n ƒë√£ ho√†n th√†nh phi√™n h·ªçc t·∫≠p.');
            }
        }, 1000);
    },

    pause() {
        this.isRunning = false;
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
        }
    },

    reset() {
        this.pause();
        this.remainingSeconds = this.totalSeconds;
        this.updateDisplay();
    },

    close() {
        this.pause();
        this.reset();
        if (this.elements.overlay) {
            this.elements.overlay.style.display = 'none';
        }
    }
};

// Expose to window
window.StudyTimer = StudyTimer;

// ƒê·∫£m b·∫£o h√†m n√†y n·∫±m ·ªü c·∫•p cao nh·∫•t c·ªßa file study.js, kh√¥ng n·∫±m trong h√†m kh√°c
window.showStudyTimePage = function (el) {
    // NgƒÉn ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa th·∫ª <a>
    if (el && el.preventDefault) {
        el.preventDefault();
    }

    const sectionsToHide = [
        DOM.sections.mainDashboard,
        DOM.sections.profileSection,
        DOM.sections.documentsSection
    ];

    sectionsToHide.forEach(section => {
        if (section) section.style.display = 'none';
    });

    // Active menu sidebar - el l√† element <a> t·ª´ sidebar
    if (UI && UI.setActiveMenu) {
        UI.setActiveMenu(el || null);
    }

    // Kh·ªüi t·∫°o l·∫°i StudyTimer
    if (!StudyTimer.elements || !StudyTimer.elements.overlay) {
        StudyTimer.init();
    }

    // M·ªü overlay
    StudyTimer.open();
};

let selectedMinutes = 25; // Bi·∫øn l∆∞u th·ªùi gian ƒë∆∞·ª£c ch·ªçn

// M·ªü modal ch·ªçn th·ªùi gian
function openTimePickerModal() {
    const modal = document.getElementById('timePickerModal');
    const slider = document.getElementById('time-slider');

    if (modal && slider) {
        // ƒê·∫∑t gi√° tr·ªã hi·ªán t·∫°i
        slider.value = selectedMinutes;
        updateTimeDisplay(selectedMinutes);
        updateSliderProgress(selectedMinutes);
        highlightActivePreset(selectedMinutes);

        // Hi·ªÉn th·ªã modal
        modal.classList.add('active');
    }
}

// ƒê√≥ng modal
function closeTimePickerModal() {
    const modal = document.getElementById('timePickerModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// C·∫≠p nh·∫≠t hi·ªÉn th·ªã s·ªë ph√∫t khi k√©o slider
function updateTimeDisplay(minutes) {
    const valueElement = document.getElementById('time-value');
    if (valueElement) {
        valueElement.textContent = minutes;
    }

    selectedMinutes = parseInt(minutes);
    updateSliderProgress(minutes);
    highlightActivePreset(minutes);
}

// C·∫≠p nh·∫≠t m√†u slider (gradient progress)
function updateSliderProgress(minutes) {
    const slider = document.getElementById('time-slider');
    if (slider) {
        const min = parseInt(slider.min);
        const max = parseInt(slider.max);
        const progress = ((minutes - min) / (max - min)) * 100;
        slider.style.setProperty('--slider-progress', progress + '%');
    }
}

// Highlight preset button ƒëang active
function highlightActivePreset(minutes) {
    const presetButtons = document.querySelectorAll('.preset-btn');
    presetButtons.forEach(btn => {
        btn.classList.remove('active');
    });

    // T√¨m v√† highlight n√∫t t∆∞∆°ng ·ª©ng
    presetButtons.forEach(btn => {
        const btnMinutes = parseInt(btn.textContent);
        if (btnMinutes === parseInt(minutes)) {
            btn.classList.add('active');
        }
    });
}

// ƒê·∫∑t th·ªùi gian t·ª´ preset button
function setTimeFromModal(minutes) {
    const slider = document.getElementById('time-slider');
    if (slider) {
        slider.value = minutes;
        updateTimeDisplay(minutes);
    }
}

// X√°c nh·∫≠n v√† √°p d·ª•ng th·ªùi gian
function applyCustomTime() {
    if (selectedMinutes && selectedMinutes > 0) {
        // G·ªçi h√†m setTime c·ªßa StudyTimer
        if (StudyTimer && StudyTimer.setTime) {
            StudyTimer.setTime(selectedMinutes);
        }

        // ƒê√≥ng modal
        closeTimePickerModal();
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('timePickerModal');
    if (modal) {
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                closeTimePickerModal();
            }
        });
    }
});

function scrollDocs(direction) {
    const container = document.getElementById('docScrollContainer');
    const scrollAmount = 300; // ƒê·ªô d√†i m·ªói l·∫ßn b·∫•m cu·ªôn
    if (direction === 'left') {
        container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
}

// ==================== PROFILE MANAGER (X·ª¨ L√ù TAB H·ªí S∆†) ====================
const ProfileManager = {
    // Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab
    switchTab(tabName) {
        // 1. ·∫®n t·∫•t c·∫£ n·ªôi dung tab
        const contents = document.querySelectorAll('.profile-tab-content');
        contents.forEach(el => el.style.display = 'none');

        // 2. B·ªè active ·ªü menu b√™n tr√°i
        const menuItems = document.querySelectorAll('.p-menu-item');
        menuItems.forEach(el => el.classList.remove('active'));

        // 3. Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
        const selectedContent = document.getElementById('tab-' + tabName);
        if (selectedContent) selectedContent.style.display = 'block';

        // 4. Active menu t∆∞∆°ng ·ª©ng
        const selectedMenu = document.getElementById('menu-' + tabName);
        if (selectedMenu) selectedMenu.classList.add('active');

        // 5. Load d·ªØ li·ªáu t∆∞∆°ng ·ª©ng
        if (tabName === 'my-docs') {
            this.renderMyDocs();
        } else if (tabName === 'saved') {
            this.renderSavedDocs();
        }
    },

    // Render T√†i li·ªáu c·ªßa t√¥i (Do user upload)
    renderMyDocs() {
        const container = document.getElementById('profile-my-docs-list');
        if (!container || !AppState.currentUser) return;

        // L·ªçc t√†i li·ªáu: Ng∆∞·ªùi upload tr√πng t√™n User hi·ªán t·∫°i
        // L∆∞u √Ω: L√∫c upload b·∫°n l∆∞u l√† fullName, n√™n so s√°nh theo fullName
        const myDocs = AppState.allDocuments.filter(doc =>
            doc.uploader === AppState.currentUser.fullName
        );

        if (myDocs.length === 0) {
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #9ca3af;"><svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-bottom: 10px;"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg><p>B·∫°n ch∆∞a t·∫£i l√™n t√†i li·ªáu n√†o.</p></div>';
        } else {
            // T√°i s·ª≠ d·ª•ng h√†m render c√≥ s·∫µn c·ªßa DocumentManager
            DocumentManager.renderDocuments(myDocs, container);
        }
    },

    // Render T√†i li·ªáu ƒë√£ l∆∞u
    renderSavedDocs() {
        const container = document.getElementById('profile-saved-list');
        if (!container || !AppState.currentUser) return;

        const savedIds = AppState.currentUser.savedDocs || [];

        // L·ªçc t√†i li·ªáu: ID n·∫±m trong danh s√°ch ƒë√£ l∆∞u
        const savedDocs = AppState.allDocuments.filter(doc =>
            savedIds.includes(doc.id)
        );

        if (savedDocs.length === 0) {
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #9ca3af;"><svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-bottom: 10px;"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg><p>B·∫°n ch∆∞a l∆∞u t√†i li·ªáu n√†o.</p></div>';
        } else {
            // T√°i s·ª≠ d·ª•ng h√†m render c√≥ s·∫µn
            DocumentManager.renderDocuments(savedDocs, container);
        }
    }
};

// Expose ra window ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c
window.ProfileManager = ProfileManager;