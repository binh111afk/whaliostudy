/**
 * ==================== ADMIN ROUTER ====================
 * Module quáº£n lÃ½ Admin Panel cho Whalio Study
 * 
 * ðŸ“‹ MODULES:
 * 1. User Management - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
 * 2. Security Monitoring - GiÃ¡m sÃ¡t báº£o máº­t
 * 3. Statistics - Thá»‘ng kÃª & Analytics
 * 4. Database Backup - Sao lÆ°u há»‡ thá»‘ng
 * 5. Maintenance - Báº£o trÃ¬ há»‡ thá»‘ng
 * 
 * ðŸ”§ USAGE - Maintenance Middleware:
 * Äá»ƒ kÃ­ch hoáº¡t maintenance mode cho toÃ n bá»™ há»‡ thá»‘ng, thÃªm vÃ o server/index.js:
 * 
 * const adminRouter = require('./routes/admin');
 * app.use(adminRouter.maintenanceCheck); // ThÃªm TRÆ¯á»šC cÃ¡c routes khÃ¡c
 * app.use('/api/admin', adminRouter);
 * 
 * Middleware sáº½ cháº·n má»i request (tráº£ vá» 503) khi isEnabled = true
 * Admin panel váº«n truy cáº­p Ä‘Æ°á»£c qua /api/admin/*
 * 
 * ðŸ‘‘ ENDPOINTS Tá»”NG QUÃT:
 * - /api/admin/users              : User Management
 * - /api/admin/security/*         : Security Monitoring  
 * - /api/admin/stats/*            : Statistics
 * - /api/admin/backups/*          : Database Backup
 * - /api/admin/maintenance/*      : Maintenance Mode
 */

const express = require('express');
const router = express.Router();

// ==================== MOCK DATA - CHUáº¨N FIGMA ====================
const mockUsers = [
    {
        id: 'SV001234',
        fullName: 'Nguyá»…n VÄƒn Anh',
        email: 'sv001234@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV001234',
        device: 'Lenovo LOQ',
        studyTime: '42h 15m',
        studyTimeMinutes: 2535,
        lastIP: '192.168.1.45',
        lastLogin: '2026-02-20T08:30:00Z',
        isLocked: false,
        role: 'student',
        createdAt: '2024-09-01T00:00:00Z',
        status: 'active'
    },
    {
        id: 'SV002345',
        fullName: 'Tráº§n Thá»‹ BÃ¬nh',
        email: 'sv002345@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV002345',
        device: 'MacBook Pro M3',
        studyTime: '38h 42m',
        studyTimeMinutes: 2322,
        lastIP: '10.0.0.128',
        lastLogin: '2026-02-19T14:22:00Z',
        isLocked: false,
        role: 'student',
        createdAt: '2024-09-05T00:00:00Z',
        status: 'active'
    },
    {
        id: 'SV003456',
        fullName: 'LÃª HoÃ ng CÆ°á»ng',
        email: 'sv003456@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV003456',
        device: 'ASUS ROG Strix',
        studyTime: '56h 08m',
        studyTimeMinutes: 3368,
        lastIP: '172.16.0.55',
        lastLogin: '2026-02-20T10:15:00Z',
        isLocked: false,
        role: 'student',
        createdAt: '2024-08-28T00:00:00Z',
        status: 'active'
    },
    {
        id: 'SV004567',
        fullName: 'Pháº¡m Minh DÅ©ng',
        email: 'sv004567@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV004567',
        device: 'Dell XPS 15',
        studyTime: '12h 30m',
        studyTimeMinutes: 750,
        lastIP: '192.168.2.100',
        lastLogin: '2026-02-10T09:00:00Z',
        isLocked: true,
        role: 'student',
        createdAt: '2024-10-01T00:00:00Z',
        status: 'locked'
    },
    {
        id: 'SV005678',
        fullName: 'HoÃ ng Thá»‹ HÆ°Æ¡ng',
        email: 'sv005678@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV005678',
        device: 'HP Pavilion',
        studyTime: '28h 55m',
        studyTimeMinutes: 1735,
        lastIP: '192.168.1.200',
        lastLogin: '2026-02-18T16:45:00Z',
        isLocked: false,
        role: 'student',
        createdAt: '2024-09-15T00:00:00Z',
        status: 'active'
    },
    {
        id: 'SV006789',
        fullName: 'VÅ© Äá»©c Khang',
        email: 'sv006789@student.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=SV006789',
        device: 'Acer Nitro 5',
        studyTime: '65h 20m',
        studyTimeMinutes: 3920,
        lastIP: '10.10.10.88',
        lastLogin: '2026-02-20T07:00:00Z',
        isLocked: false,
        role: 'student',
        createdAt: '2024-08-20T00:00:00Z',
        status: 'active'
    },
    {
        id: 'AD000001',
        fullName: 'Admin Whalio',
        email: 'admin@whalio.edu.vn',
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Admin',
        device: 'MacBook Pro M2 Max',
        studyTime: '0h 0m',
        studyTimeMinutes: 0,
        lastIP: '127.0.0.1',
        lastLogin: '2026-02-20T11:00:00Z',
        isLocked: false,
        role: 'admin',
        createdAt: '2024-01-01T00:00:00Z',
        status: 'active'
    }
];

// ==================== MOCK ACTIVITY LOGS ====================
const mockActivityLogs = {
    'SV001234': [
        { id: 1, action: 'login', description: 'ÄÄƒng nháº­p thÃ nh cÃ´ng', ip: '192.168.1.45', device: 'Lenovo LOQ', timestamp: '2026-02-20T08:30:00Z' },
        { id: 2, action: 'study', description: 'Báº¯t Ä‘áº§u phiÃªn há»c: ToÃ¡n Cao Cáº¥p', ip: '192.168.1.45', device: 'Lenovo LOQ', timestamp: '2026-02-20T08:35:00Z' },
        { id: 3, action: 'exam', description: 'HoÃ n thÃ nh bÃ i kiá»ƒm tra: Quiz Giáº£i TÃ­ch', ip: '192.168.1.45', device: 'Lenovo LOQ', timestamp: '2026-02-20T09:15:00Z' },
        { id: 4, action: 'document', description: 'Táº£i lÃªn tÃ i liá»‡u: BÃ i táº­p chÆ°Æ¡ng 5.pdf', ip: '192.168.1.45', device: 'Lenovo LOQ', timestamp: '2026-02-20T10:00:00Z' },
        { id: 5, action: 'logout', description: 'ÄÄƒng xuáº¥t', ip: '192.168.1.45', device: 'Lenovo LOQ', timestamp: '2026-02-20T12:00:00Z' }
    ],
    'SV002345': [
        { id: 1, action: 'login', description: 'ÄÄƒng nháº­p thÃ nh cÃ´ng', ip: '10.0.0.128', device: 'MacBook Pro M3', timestamp: '2026-02-19T14:22:00Z' },
        { id: 2, action: 'flashcard', description: 'Há»c Flashcard: Tiáº¿ng Anh Unit 5', ip: '10.0.0.128', device: 'MacBook Pro M3', timestamp: '2026-02-19T14:30:00Z' },
        { id: 3, action: 'ai_chat', description: 'Sá»­ dá»¥ng AI Chat: Há»i vá» Váº­t LÃ½', ip: '10.0.0.128', device: 'MacBook Pro M3', timestamp: '2026-02-19T15:00:00Z' }
    ],
    'SV003456': [
        { id: 1, action: 'login', description: 'ÄÄƒng nháº­p thÃ nh cÃ´ng', ip: '172.16.0.55', device: 'ASUS ROG Strix', timestamp: '2026-02-20T10:15:00Z' },
        { id: 2, action: 'study', description: 'Báº¯t Ä‘áº§u phiÃªn há»c: Láº­p TrÃ¬nh Web', ip: '172.16.0.55', device: 'ASUS ROG Strix', timestamp: '2026-02-20T10:20:00Z' },
        { id: 3, action: 'deadline', description: 'Táº¡o deadline: Ná»™p bÃ i táº­p React', ip: '172.16.0.55', device: 'ASUS ROG Strix', timestamp: '2026-02-20T10:45:00Z' }
    ],
    'SV004567': [
        { id: 1, action: 'login_failed', description: 'ÄÄƒng nháº­p tháº¥t báº¡i - Sai máº­t kháº©u', ip: '192.168.2.100', device: 'Dell XPS 15', timestamp: '2026-02-10T08:55:00Z' },
        { id: 2, action: 'login_failed', description: 'ÄÄƒng nháº­p tháº¥t báº¡i - Sai máº­t kháº©u', ip: '192.168.2.100', device: 'Dell XPS 15', timestamp: '2026-02-10T08:56:00Z' },
        { id: 3, action: 'account_locked', description: 'TÃ i khoáº£n bá»‹ khÃ³a do Ä‘Äƒng nháº­p sai quÃ¡ nhiá»u', ip: '192.168.2.100', device: 'Dell XPS 15', timestamp: '2026-02-10T09:00:00Z' }
    ],
    'SV005678': [
        { id: 1, action: 'login', description: 'ÄÄƒng nháº­p thÃ nh cÃ´ng', ip: '192.168.1.200', device: 'HP Pavilion', timestamp: '2026-02-18T16:45:00Z' },
        { id: 2, action: 'timetable', description: 'Cáº­p nháº­t thá»i khÃ³a biá»ƒu', ip: '192.168.1.200', device: 'HP Pavilion', timestamp: '2026-02-18T17:00:00Z' }
    ],
    'SV006789': [
        { id: 1, action: 'login', description: 'ÄÄƒng nháº­p thÃ nh cÃ´ng', ip: '10.10.10.88', device: 'Acer Nitro 5', timestamp: '2026-02-20T07:00:00Z' },
        { id: 2, action: 'study', description: 'Marathon há»c táº­p: 4 giá» liÃªn tá»¥c', ip: '10.10.10.88', device: 'Acer Nitro 5', timestamp: '2026-02-20T07:05:00Z' },
        { id: 3, action: 'achievement', description: 'Äáº¡t thÃ nh tÃ­ch: Top learner tuáº§n', ip: '10.10.10.88', device: 'Acer Nitro 5', timestamp: '2026-02-20T11:05:00Z' }
    ]
};

// ==================== API ENDPOINTS ====================

/**
 * GET /users
 * Láº¥y danh sÃ¡ch toÃ n bá»™ user
 * Query params:
 *   - search: TÃ¬m kiáº¿m theo tÃªn/email/ID
 *   - status: Lá»c theo tráº¡ng thÃ¡i (active/locked/all)
 *   - role: Lá»c theo role (student/admin/all)
 *   - sortBy: Sáº¯p xáº¿p theo trÆ°á»ng (studyTime/lastLogin/createdAt)
 *   - order: Thá»© tá»± (asc/desc)
 *   - page: Sá»‘ trang
 *   - limit: Sá»‘ lÆ°á»£ng má»—i trang
 */
router.get('/users', (req, res) => {
    try {
        const { 
            search = '', 
            status = 'all', 
            role = 'all',
            sortBy = 'lastLogin',
            order = 'desc',
            page = 1,
            limit = 10
        } = req.query;

        let filteredUsers = [...mockUsers];

        // TÃ¬m kiáº¿m
        if (search) {
            const searchLower = search.toLowerCase();
            filteredUsers = filteredUsers.filter(user => 
                user.fullName.toLowerCase().includes(searchLower) ||
                user.email.toLowerCase().includes(searchLower) ||
                user.id.toLowerCase().includes(searchLower)
            );
        }

        // Lá»c theo tráº¡ng thÃ¡i
        if (status !== 'all') {
            filteredUsers = filteredUsers.filter(user => user.status === status);
        }

        // Lá»c theo role
        if (role !== 'all') {
            filteredUsers = filteredUsers.filter(user => user.role === role);
        }

        // Sáº¯p xáº¿p
        filteredUsers.sort((a, b) => {
            let comparison = 0;
            switch (sortBy) {
                case 'studyTime':
                    comparison = a.studyTimeMinutes - b.studyTimeMinutes;
                    break;
                case 'lastLogin':
                    comparison = new Date(a.lastLogin) - new Date(b.lastLogin);
                    break;
                case 'createdAt':
                    comparison = new Date(a.createdAt) - new Date(b.createdAt);
                    break;
                case 'fullName':
                    comparison = a.fullName.localeCompare(b.fullName);
                    break;
                default:
                    comparison = new Date(a.lastLogin) - new Date(b.lastLogin);
            }
            return order === 'desc' ? -comparison : comparison;
        });

        // PhÃ¢n trang
        const startIndex = (parseInt(page) - 1) * parseInt(limit);
        const endIndex = startIndex + parseInt(limit);
        const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

        // Thá»‘ng kÃª tá»•ng quan
        const stats = {
            totalUsers: mockUsers.length,
            activeUsers: mockUsers.filter(u => u.status === 'active').length,
            lockedUsers: mockUsers.filter(u => u.status === 'locked').length,
            totalStudyTime: mockUsers.reduce((acc, u) => acc + u.studyTimeMinutes, 0),
            onlineNow: Math.floor(Math.random() * 10) + 1 // Mock sá»‘ ngÆ°á»i online
        };

        res.json({
            success: true,
            data: paginatedUsers,
            pagination: {
                currentPage: parseInt(page),
                totalPages: Math.ceil(filteredUsers.length / parseInt(limit)),
                totalItems: filteredUsers.length,
                itemsPerPage: parseInt(limit)
            },
            stats
        });

    } catch (error) {
        console.error('âŒ Error fetching users:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch ngÆ°á»i dÃ¹ng',
            error: error.message
        });
    }
});

/**
 * GET /users/:id
 * Láº¥y thÃ´ng tin chi tiáº¿t má»™t user
 */
router.get('/users/:id', (req, res) => {
    try {
        const { id } = req.params;
        const user = mockUsers.find(u => u.id === id);

        if (!user) {
            return res.status(404).json({
                success: false,
                message: 'KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng'
            });
        }

        res.json({
            success: true,
            data: user
        });

    } catch (error) {
        console.error('âŒ Error fetching user:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng',
            error: error.message
        });
    }
});

/**
 * PATCH /users/:id/lock
 * Äáº£o tráº¡ng thÃ¡i khÃ³a/má»Ÿ khÃ³a tÃ i khoáº£n
 */
router.patch('/users/:id/lock', (req, res) => {
    try {
        const { id } = req.params;
        const { reason } = req.body; // LÃ½ do khÃ³a (optional)
        
        const userIndex = mockUsers.findIndex(u => u.id === id);

        if (userIndex === -1) {
            return res.status(404).json({
                success: false,
                message: 'KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng'
            });
        }

        // KhÃ´ng cho phÃ©p khÃ³a admin
        if (mockUsers[userIndex].role === 'admin') {
            return res.status(403).json({
                success: false,
                message: 'KhÃ´ng thá»ƒ khÃ³a tÃ i khoáº£n Admin'
            });
        }

        // Äáº£o tráº¡ng thÃ¡i
        const wasLocked = mockUsers[userIndex].isLocked;
        mockUsers[userIndex].isLocked = !wasLocked;
        mockUsers[userIndex].status = mockUsers[userIndex].isLocked ? 'locked' : 'active';

        // ThÃªm log activity
        const action = mockUsers[userIndex].isLocked ? 'account_locked' : 'account_unlocked';
        const description = mockUsers[userIndex].isLocked 
            ? `TÃ i khoáº£n bá»‹ khÃ³a bá»Ÿi Admin${reason ? `: ${reason}` : ''}`
            : 'TÃ i khoáº£n Ä‘Æ°á»£c má»Ÿ khÃ³a bá»Ÿi Admin';

        if (!mockActivityLogs[id]) {
            mockActivityLogs[id] = [];
        }

        mockActivityLogs[id].push({
            id: mockActivityLogs[id].length + 1,
            action,
            description,
            ip: 'Admin Panel',
            device: 'Admin Dashboard',
            timestamp: new Date().toISOString()
        });

        res.json({
            success: true,
            message: mockUsers[userIndex].isLocked 
                ? 'ÄÃ£ khÃ³a tÃ i khoáº£n thÃ nh cÃ´ng' 
                : 'ÄÃ£ má»Ÿ khÃ³a tÃ i khoáº£n thÃ nh cÃ´ng',
            data: {
                id: mockUsers[userIndex].id,
                isLocked: mockUsers[userIndex].isLocked,
                status: mockUsers[userIndex].status
            }
        });

    } catch (error) {
        console.error('âŒ Error toggling user lock:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi khÃ³a/má»Ÿ khÃ³a tÃ i khoáº£n',
            error: error.message
        });
    }
});

/**
 * POST /users/:id/reset
 * Reset máº­t kháº©u vá» máº·c Ä‘á»‹nh
 */
router.post('/users/:id/reset', (req, res) => {
    try {
        const { id } = req.params;
        const { sendEmail = true } = req.body; // CÃ³ gá»­i email thÃ´ng bÃ¡o khÃ´ng
        
        const user = mockUsers.find(u => u.id === id);

        if (!user) {
            return res.status(404).json({
                success: false,
                message: 'KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng'
            });
        }

        // Generate máº­t kháº©u má»›i (trong thá»±c táº¿ sáº½ hash vÃ  lÆ°u DB)
        const newPassword = generateRandomPassword();
        const maskedPassword = newPassword.substring(0, 3) + '****';

        // ThÃªm log activity
        if (!mockActivityLogs[id]) {
            mockActivityLogs[id] = [];
        }

        mockActivityLogs[id].push({
            id: mockActivityLogs[id].length + 1,
            action: 'password_reset',
            description: 'Máº­t kháº©u Ä‘Æ°á»£c reset bá»Ÿi Admin',
            ip: 'Admin Panel',
            device: 'Admin Dashboard',
            timestamp: new Date().toISOString()
        });

        res.json({
            success: true,
            message: 'Reset máº­t kháº©u thÃ nh cÃ´ng',
            data: {
                id: user.id,
                email: user.email,
                newPassword: maskedPassword, // Chá»‰ hiá»ƒn thá»‹ má»™t pháº§n
                emailSent: sendEmail
            }
        });

    } catch (error) {
        console.error('âŒ Error resetting password:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi reset máº­t kháº©u',
            error: error.message
        });
    }
});

/**
 * GET /users/:id/logs
 * Láº¥y lá»‹ch sá»­ hoáº¡t Ä‘á»™ng cá»§a user
 */
router.get('/users/:id/logs', (req, res) => {
    try {
        const { id } = req.params;
        const { 
            action = 'all', // Lá»c theo loáº¡i action
            limit = 50,
            page = 1
        } = req.query;

        const user = mockUsers.find(u => u.id === id);

        if (!user) {
            return res.status(404).json({
                success: false,
                message: 'KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng'
            });
        }

        let logs = mockActivityLogs[id] || [];

        // Lá»c theo action type
        if (action !== 'all') {
            logs = logs.filter(log => log.action === action);
        }

        // Sáº¯p xáº¿p má»›i nháº¥t lÃªn Ä‘áº§u
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // PhÃ¢n trang
        const startIndex = (parseInt(page) - 1) * parseInt(limit);
        const endIndex = startIndex + parseInt(limit);
        const paginatedLogs = logs.slice(startIndex, endIndex);

        res.json({
            success: true,
            data: {
                user: {
                    id: user.id,
                    fullName: user.fullName,
                    email: user.email
                },
                logs: paginatedLogs,
                pagination: {
                    currentPage: parseInt(page),
                    totalPages: Math.ceil(logs.length / parseInt(limit)),
                    totalItems: logs.length
                }
            }
        });

    } catch (error) {
        console.error('âŒ Error fetching user logs:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi láº¥y lá»‹ch sá»­ hoáº¡t Ä‘á»™ng',
            error: error.message
        });
    }
});

/**
 * GET /stats
 * Thá»‘ng kÃª tá»•ng quan cho Dashboard Admin
 */
router.get('/stats', (req, res) => {
    try {
        const totalStudyMinutes = mockUsers.reduce((acc, u) => acc + u.studyTimeMinutes, 0);
        const avgStudyMinutes = Math.round(totalStudyMinutes / mockUsers.length);
        
        const stats = {
            users: {
                total: mockUsers.length,
                active: mockUsers.filter(u => u.status === 'active').length,
                locked: mockUsers.filter(u => u.status === 'locked').length,
                students: mockUsers.filter(u => u.role === 'student').length,
                admins: mockUsers.filter(u => u.role === 'admin').length
            },
            studyTime: {
                total: formatMinutesToHours(totalStudyMinutes),
                totalMinutes: totalStudyMinutes,
                average: formatMinutesToHours(avgStudyMinutes),
                averageMinutes: avgStudyMinutes
            },
            activity: {
                onlineNow: Math.floor(Math.random() * 15) + 3,
                todayLogins: Math.floor(Math.random() * 50) + 20,
                weeklyActiveUsers: Math.floor(Math.random() * 100) + 50
            },
            topLearners: mockUsers
                .filter(u => u.role === 'student')
                .sort((a, b) => b.studyTimeMinutes - a.studyTimeMinutes)
                .slice(0, 5)
                .map(u => ({
                    id: u.id,
                    fullName: u.fullName,
                    studyTime: u.studyTime,
                    avatar: u.avatar
                }))
        };

        res.json({
            success: true,
            data: stats
        });

    } catch (error) {
        console.error('âŒ Error fetching admin stats:', error);
        res.status(500).json({
            success: false,
            message: 'Lá»—i khi láº¥y thá»‘ng kÃª',
            error: error.message
        });
    }
});

// ==================== SECURITY MONITORING MODULE ====================
// Module GiÃ¡m sÃ¡t báº£o máº­t - Theo dÃµi traffic, server vÃ  cháº·n táº¥n cÃ´ng

// ==================== SECURITY MOCK DATA ====================

// Traffic data - Biá»ƒu Ä‘á»“ tá»« 10:00 Ä‘áº¿n 10:30
const mockTrafficData = {
    currentRequests: 1250,
    averageRequests: 403,
    peakRequests: 1250,
    timeRange: '10:00 - 10:30',
    chart: [
        { time: '10:00', requests: 320 },
        { time: '10:05', requests: 450 },
        { time: '10:10', requests: 380 },
        { time: '10:15', requests: 520 },
        { time: '10:20', requests: 890 },
        { time: '10:25', requests: 1100 },
        { time: '10:30', requests: 1250 }
    ],
    breakdown: {
        api: 720,
        static: 380,
        websocket: 150
    },
    statusCodes: {
        '2xx': 1180,
        '3xx': 25,
        '4xx': 38,
        '5xx': 7
    }
};

// Danh sÃ¡ch IP Ä‘Ã¡ng ngá»
const mockSuspiciousIPs = [
    {
        id: 1,
        ip: '192.168.1.45',
        attackType: 'Brute Force',
        attempts: 125,
        firstSeen: '2026-02-20T08:15:00Z',
        lastSeen: '2026-02-20T10:25:00Z',
        targetEndpoint: '/api/auth/login',
        status: 'active',
        country: 'Vietnam',
        isp: 'Viettel'
    },
    {
        id: 2,
        ip: '10.0.0.88',
        attackType: 'DDOS',
        attempts: 89,
        firstSeen: '2026-02-20T09:30:00Z',
        lastSeen: '2026-02-20T10:20:00Z',
        targetEndpoint: '/api/*',
        status: 'active',
        country: 'China',
        isp: 'Unknown'
    },
    {
        id: 3,
        ip: '172.16.0.12',
        attackType: 'SQL Injection',
        attempts: 67,
        firstSeen: '2026-02-20T07:45:00Z',
        lastSeen: '2026-02-20T10:10:00Z',
        targetEndpoint: '/api/documents/search',
        status: 'active',
        country: 'Russia',
        isp: 'Unknown'
    },
    {
        id: 4,
        ip: '203.45.67.89',
        attackType: 'XSS',
        attempts: 34,
        firstSeen: '2026-02-19T22:00:00Z',
        lastSeen: '2026-02-20T06:30:00Z',
        targetEndpoint: '/api/community/posts',
        status: 'blocked',
        country: 'India',
        isp: 'Unknown'
    }
];

// Danh sÃ¡ch IP bá»‹ cháº·n (Blacklist)
let blockedIPs = ['203.45.67.89'];

// Tráº¡ng thÃ¡i Server
const mockServerStatus = {
    cpu: 45,
    ram: 68,
    disk: 34,
    uptime: '15 ngÃ y 7 giá»',
    uptimeSeconds: 1317600,
    totalPushes: 557,
    lastDeployTime: '2026-02-20T08:30:00Z',
    lastDeployVersion: 'v2.4.1',
    stableVersion: 'v2.4.0',
    nodeVersion: 'v20.11.0',
    platform: 'Ubuntu 22.04 LTS',
    hostname: 'whalio-prod-01',
    network: {
        inbound: '245 MB/s',
        outbound: '128 MB/s'
    },
    activeConnections: 342,
    processMemory: '512 MB'
};

// Sá»± kiá»‡n há»‡ thá»‘ng gáº§n Ä‘Ã¢y
const mockSystemEvents = [
    {
        id: 1,
        type: 'deploy',
        severity: 'success',
        title: 'Deploy thÃ nh cÃ´ng',
        description: 'Version v2.4.1 deployed to production',
        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 giá» trÆ°á»›c
        relativeTime: '2 giá» trÆ°á»›c',
        details: { version: 'v2.4.1', environment: 'production', duration: '45s' }
    },
    {
        id: 2,
        type: 'backup',
        severity: 'success',
        title: 'Database backup hoÃ n táº¥t',
        description: 'Daily backup completed successfully - 2.4GB',
        timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(), // 5 giá» trÆ°á»›c
        relativeTime: '5 giá» trÆ°á»›c',
        details: { size: '2.4GB', duration: '12m 34s', destination: 'AWS S3' }
    },
    {
        id: 3,
        type: 'warning',
        severity: 'warning',
        title: 'RAM usage Ä‘áº¡t 75%',
        description: 'Memory usage exceeded warning threshold',
        timestamp: new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString(), // 8 giá» trÆ°á»›c
        relativeTime: '8 giá» trÆ°á»›c',
        details: { threshold: '70%', current: '75%', action: 'Auto-scaled' }
    },
    {
        id: 4,
        type: 'security',
        severity: 'danger',
        title: 'PhÃ¡t hiá»‡n táº¥n cÃ´ng Brute Force',
        description: 'Multiple failed login attempts from 192.168.1.45',
        timestamp: new Date(Date.now() - 10 * 60 * 60 * 1000).toISOString(),
        relativeTime: '10 giá» trÆ°á»›c',
        details: { ip: '192.168.1.45', attempts: 125, action: 'Rate limited' }
    },
    {
        id: 5,
        type: 'system',
        severity: 'info',
        title: 'SSL Certificate renewed',
        description: 'Auto-renewal completed for *.whalio.edu.vn',
        timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
        relativeTime: '1 ngÃ y trÆ°á»›c',
        details: { domain: '*.whalio.edu.vn', expiry: '2027-02-20' }
    },
    {
        id: 6,
        type: 'deploy',
        severity: 'success',
        title: 'Hotfix deployed',
        description: 'Critical security patch v2.4.0-hotfix applied',
        timestamp: new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString(),
        relativeTime: '2 ngÃ y trÆ°á»›c',
        details: { version: 'v2.4.0-hotfix', issue: 'CVE-2026-1234' }
    }
];

// ==================== SECURITY LOGGER MIDDLEWARE ====================
/**
 * Middleware ghi láº¡i nháº­t kÃ½ má»—i khi Admin gá»i cÃ¡c API báº£o máº­t nháº¡y cáº£m
 */
const securityLogger = (req, res, next) => {
    const logEntry = {
        timestamp: new Date().toISOString(),
        method: req.method,
        endpoint: req.originalUrl,
        ip: req.ip || req.connection.remoteAddress,
        userAgent: req.get('User-Agent'),
        body: req.method !== 'GET' ? JSON.stringify(req.body) : null
    };
    
    console.log('ðŸ” [SECURITY LOG]', JSON.stringify(logEntry));
    
    // Trong thá»±c táº¿ sáº½ ghi vÃ o file hoáº·c database
    // fs.appendFileSync('security.log', JSON.stringify(logEntry) + '\n');
    
    next();
};

// ==================== SECURITY API ENDPOINTS ====================

/**
 * GET /security/traffic
 * Láº¥y dá»¯ liá»‡u biá»ƒu Ä‘á»“ traffic vÃ  cÃ¡c con sá»‘ tá»•ng quÃ¡t
 */
router.get('/security/traffic', securityLogger, (req, res) => {
    try {
        const { timeRange = '30m' } = req.query;
        
        // Simulate different time ranges
        let data = { ...mockTrafficData };
        
        if (timeRange === '1h') {
            data.timeRange = '09:30 - 10:30';
            data.averageRequests = 520;
        } else if (timeRange === '24h') {
            data.timeRange = '10:30 hÃ´m qua - 10:30 hÃ´m nay';
            data.averageRequests = 380;
            data.peakRequests = 2100;
        }

        res.json({
            success: true,
            data: data,
            message: 'Láº¥y dá»¯ liá»‡u traffic thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching traffic data:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y dá»¯ liá»‡u traffic'
        });
    }
});

/**
 * GET /security/suspicious-ips
 * Láº¥y danh sÃ¡ch cÃ¡c IP bá»‹ cáº£nh bÃ¡o
 */
router.get('/security/suspicious-ips', securityLogger, (req, res) => {
    try {
        const { 
            attackType = 'all',
            status = 'all',
            sortBy = 'attempts',
            order = 'desc'
        } = req.query;

        let filteredIPs = [...mockSuspiciousIPs];

        // ÄÃ¡nh dáº¥u IP Ä‘Ã£ bá»‹ block
        filteredIPs = filteredIPs.map(ip => ({
            ...ip,
            isBlocked: blockedIPs.includes(ip.ip)
        }));

        // Lá»c theo loáº¡i táº¥n cÃ´ng
        if (attackType !== 'all') {
            filteredIPs = filteredIPs.filter(ip => 
                ip.attackType.toLowerCase() === attackType.toLowerCase()
            );
        }

        // Lá»c theo tráº¡ng thÃ¡i
        if (status !== 'all') {
            if (status === 'blocked') {
                filteredIPs = filteredIPs.filter(ip => blockedIPs.includes(ip.ip));
            } else {
                filteredIPs = filteredIPs.filter(ip => !blockedIPs.includes(ip.ip));
            }
        }

        // Sáº¯p xáº¿p
        filteredIPs.sort((a, b) => {
            let comparison = 0;
            if (sortBy === 'attempts') {
                comparison = a.attempts - b.attempts;
            } else if (sortBy === 'lastSeen') {
                comparison = new Date(a.lastSeen) - new Date(b.lastSeen);
            }
            return order === 'desc' ? -comparison : comparison;
        });

        // Thá»‘ng kÃª
        const stats = {
            totalSuspicious: mockSuspiciousIPs.length,
            blocked: blockedIPs.length,
            active: mockSuspiciousIPs.filter(ip => !blockedIPs.includes(ip.ip)).length,
            byType: {
                'Brute Force': mockSuspiciousIPs.filter(ip => ip.attackType === 'Brute Force').length,
                'DDOS': mockSuspiciousIPs.filter(ip => ip.attackType === 'DDOS').length,
                'SQL Injection': mockSuspiciousIPs.filter(ip => ip.attackType === 'SQL Injection').length,
                'XSS': mockSuspiciousIPs.filter(ip => ip.attackType === 'XSS').length
            }
        };

        res.json({
            success: true,
            data: {
                ips: filteredIPs,
                stats: stats
            },
            message: 'Láº¥y danh sÃ¡ch IP Ä‘Ã¡ng ngá» thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching suspicious IPs:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch IP Ä‘Ã¡ng ngá»'
        });
    }
});

/**
 * POST /security/ips/block
 * Cháº·n má»™t hoáº·c nhiá»u IP (ThÃªm vÃ o Blacklist)
 */
router.post('/security/ips/block', securityLogger, (req, res) => {
    try {
        const { ips } = req.body; // Array of IPs to block

        if (!ips || !Array.isArray(ips) || ips.length === 0) {
            return res.status(400).json({
                success: false,
                data: null,
                message: 'Vui lÃ²ng cung cáº¥p danh sÃ¡ch IP cáº§n cháº·n'
            });
        }

        // Validate IP format
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        const invalidIPs = ips.filter(ip => !ipRegex.test(ip));
        
        if (invalidIPs.length > 0) {
            return res.status(400).json({
                success: false,
                data: null,
                message: `IP khÃ´ng há»£p lá»‡: ${invalidIPs.join(', ')}`
            });
        }

        // ThÃªm vÃ o blacklist (trÃ¡nh trÃ¹ng láº·p)
        const newlyBlocked = [];
        const alreadyBlocked = [];

        ips.forEach(ip => {
            if (blockedIPs.includes(ip)) {
                alreadyBlocked.push(ip);
            } else {
                blockedIPs.push(ip);
                newlyBlocked.push(ip);
            }
        });

        // Log action
        console.log(`ðŸš« ÄÃ£ cháº·n truy cáº­p tá»« cÃ¡c IP: [${newlyBlocked.join(', ')}]`);

        // Update status trong mock data
        mockSuspiciousIPs.forEach(item => {
            if (newlyBlocked.includes(item.ip)) {
                item.status = 'blocked';
            }
        });

        res.json({
            success: true,
            data: {
                blocked: newlyBlocked,
                alreadyBlocked: alreadyBlocked,
                totalBlocked: blockedIPs.length
            },
            message: newlyBlocked.length > 0 
                ? `ÄÃ£ cháº·n truy cáº­p tá»« cÃ¡c IP: [${newlyBlocked.join(', ')}]`
                : 'Táº¥t cáº£ IP Ä‘Ã£ cÃ³ trong danh sÃ¡ch cháº·n'
        });

    } catch (error) {
        console.error('âŒ Error blocking IPs:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi cháº·n IP'
        });
    }
});

/**
 * DELETE /security/ips/unblock
 * Bá» cháº·n IP (XÃ³a khá»i Blacklist)
 */
router.delete('/security/ips/unblock', securityLogger, (req, res) => {
    try {
        const { ips } = req.body;

        if (!ips || !Array.isArray(ips) || ips.length === 0) {
            return res.status(400).json({
                success: false,
                data: null,
                message: 'Vui lÃ²ng cung cáº¥p danh sÃ¡ch IP cáº§n bá» cháº·n'
            });
        }

        const unblocked = [];
        const notFound = [];

        ips.forEach(ip => {
            const index = blockedIPs.indexOf(ip);
            if (index > -1) {
                blockedIPs.splice(index, 1);
                unblocked.push(ip);
            } else {
                notFound.push(ip);
            }
        });

        console.log(`âœ… ÄÃ£ bá» cháº·n cÃ¡c IP: [${unblocked.join(', ')}]`);

        res.json({
            success: true,
            data: {
                unblocked: unblocked,
                notFound: notFound,
                totalBlocked: blockedIPs.length
            },
            message: unblocked.length > 0 
                ? `ÄÃ£ bá» cháº·n cÃ¡c IP: [${unblocked.join(', ')}]`
                : 'KhÃ´ng tÃ¬m tháº¥y IP trong danh sÃ¡ch cháº·n'
        });

    } catch (error) {
        console.error('âŒ Error unblocking IPs:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi bá» cháº·n IP'
        });
    }
});

/**
 * GET /security/server-status
 * Láº¥y thÃ´ng sá»‘ Real-time cá»§a Server
 */
router.get('/security/server-status', securityLogger, (req, res) => {
    try {
        // Simulate real-time fluctuation
        const liveStatus = {
            ...mockServerStatus,
            cpu: mockServerStatus.cpu + Math.floor(Math.random() * 10) - 5,
            ram: mockServerStatus.ram + Math.floor(Math.random() * 6) - 3,
            disk: mockServerStatus.disk,
            activeConnections: mockServerStatus.activeConnections + Math.floor(Math.random() * 20) - 10
        };

        // Ensure values stay in valid range
        liveStatus.cpu = Math.max(0, Math.min(100, liveStatus.cpu));
        liveStatus.ram = Math.max(0, Math.min(100, liveStatus.ram));
        liveStatus.activeConnections = Math.max(0, liveStatus.activeConnections);

        // Calculate health score
        const healthScore = Math.round(100 - (liveStatus.cpu * 0.3 + liveStatus.ram * 0.4 + liveStatus.disk * 0.3));
        liveStatus.healthScore = healthScore;
        liveStatus.healthStatus = healthScore >= 70 ? 'healthy' : healthScore >= 50 ? 'warning' : 'critical';

        res.json({
            success: true,
            data: liveStatus,
            message: 'Láº¥y tráº¡ng thÃ¡i server thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching server status:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y tráº¡ng thÃ¡i server'
        });
    }
});

/**
 * POST /security/rollback
 * KÃ­ch hoáº¡t script rollback server vá» phiÃªn báº£n stable trÆ°á»›c Ä‘Ã³
 */
router.post('/security/rollback', securityLogger, (req, res) => {
    try {
        const { confirmRollback, targetVersion } = req.body;

        // YÃªu cáº§u xÃ¡c nháº­n Ä‘á»ƒ trÃ¡nh rollback nháº§m
        if (!confirmRollback) {
            return res.status(400).json({
                success: false,
                data: {
                    currentVersion: mockServerStatus.lastDeployVersion,
                    stableVersion: mockServerStatus.stableVersion,
                    totalPushes: mockServerStatus.totalPushes
                },
                message: 'Vui lÃ²ng xÃ¡c nháº­n rollback báº±ng cÃ¡ch gá»­i { confirmRollback: true }'
            });
        }

        const rollbackVersion = targetVersion || mockServerStatus.stableVersion;
        
        // Log action
        console.log(`ðŸ”„ Há»‡ thá»‘ng Ä‘ang thá»±c hiá»‡n Rollback vá» phiÃªn báº£n á»•n Ä‘á»‹nh gáº§n nháº¥t (Dá»±a trÃªn má»‘c ${mockServerStatus.totalPushes} láº§n push)`);
        console.log(`ðŸ“¦ Rolling back from ${mockServerStatus.lastDeployVersion} to ${rollbackVersion}...`);

        // Simulate rollback process
        const rollbackResult = {
            previousVersion: mockServerStatus.lastDeployVersion,
            rolledBackTo: rollbackVersion,
            totalPushes: mockServerStatus.totalPushes,
            rollbackTime: new Date().toISOString(),
            estimatedDowntime: '30 giÃ¢y',
            status: 'completed'
        };

        // Update mock server status
        mockServerStatus.lastDeployVersion = rollbackVersion;
        mockServerStatus.lastDeployTime = new Date().toISOString();

        // Add system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'rollback',
            severity: 'warning',
            title: 'System Rollback',
            description: `Rolled back to ${rollbackVersion}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: rollbackResult
        });

        res.json({
            success: true,
            data: rollbackResult,
            message: `Há»‡ thá»‘ng Ä‘ang thá»±c hiá»‡n Rollback vá» phiÃªn báº£n á»•n Ä‘á»‹nh gáº§n nháº¥t (Dá»±a trÃªn má»‘c ${mockServerStatus.totalPushes} láº§n push)`
        });

    } catch (error) {
        console.error('âŒ Error performing rollback:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi thá»±c hiá»‡n rollback'
        });
    }
});

/**
 * GET /security/events
 * Láº¥y danh sÃ¡ch log sá»± kiá»‡n há»‡ thá»‘ng gáº§n Ä‘Ã¢y
 */
router.get('/security/events', securityLogger, (req, res) => {
    try {
        const {
            type = 'all',      // deploy, backup, warning, security, system
            severity = 'all', // success, warning, danger, info
            limit = 20,
            page = 1
        } = req.query;

        let filteredEvents = [...mockSystemEvents];

        // Lá»c theo loáº¡i
        if (type !== 'all') {
            filteredEvents = filteredEvents.filter(event => event.type === type);
        }

        // Lá»c theo má»©c Ä‘á»™ nghiÃªm trá»ng
        if (severity !== 'all') {
            filteredEvents = filteredEvents.filter(event => event.severity === severity);
        }

        // Sáº¯p xáº¿p má»›i nháº¥t lÃªn Ä‘áº§u
        filteredEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // PhÃ¢n trang
        const startIndex = (parseInt(page) - 1) * parseInt(limit);
        const endIndex = startIndex + parseInt(limit);
        const paginatedEvents = filteredEvents.slice(startIndex, endIndex);

        // Thá»‘ng kÃª
        const stats = {
            total: mockSystemEvents.length,
            byType: {
                deploy: mockSystemEvents.filter(e => e.type === 'deploy').length,
                backup: mockSystemEvents.filter(e => e.type === 'backup').length,
                warning: mockSystemEvents.filter(e => e.type === 'warning').length,
                security: mockSystemEvents.filter(e => e.type === 'security').length,
                system: mockSystemEvents.filter(e => e.type === 'system').length
            },
            bySeverity: {
                success: mockSystemEvents.filter(e => e.severity === 'success').length,
                warning: mockSystemEvents.filter(e => e.severity === 'warning').length,
                danger: mockSystemEvents.filter(e => e.severity === 'danger').length,
                info: mockSystemEvents.filter(e => e.severity === 'info').length
            }
        };

        res.json({
            success: true,
            data: {
                events: paginatedEvents,
                pagination: {
                    currentPage: parseInt(page),
                    totalPages: Math.ceil(filteredEvents.length / parseInt(limit)),
                    totalItems: filteredEvents.length
                },
                stats: stats
            },
            message: 'Láº¥y danh sÃ¡ch sá»± kiá»‡n thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching system events:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch sá»± kiá»‡n'
        });
    }
});

/**
 * GET /security/blacklist
 * Láº¥y danh sÃ¡ch IP Ä‘ang bá»‹ cháº·n
 */
router.get('/security/blacklist', securityLogger, (req, res) => {
    try {
        res.json({
            success: true,
            data: {
                blockedIPs: blockedIPs,
                total: blockedIPs.length
            },
            message: 'Láº¥y danh sÃ¡ch blacklist thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching blacklist:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch blacklist'
        });
    }
});

// ==================== STATISTICS MODULE ====================
// Module Thá»‘ng kÃª vÃ  Analytics - Biá»ƒu Ä‘á»“, bÃ¡o cÃ¡o tÄƒng trÆ°á»Ÿng

// ==================== STATISTICS MOCK DATA ====================

// Tá»•ng quan (Overview) - 3 chá»‰ sá»‘ chÃ­nh
const mockOverviewStats = {
    totalUsers: {
        value: 1024,
        previousValue: 832,
        growth: 23,
        label: 'Tá»•ng ngÆ°á»i dÃ¹ng',
        icon: 'users',
        color: '#3B82F6'
    },
    newDocuments: {
        value: 2847,
        previousValue: 2475,
        growth: 15,
        label: 'TÃ i liá»‡u má»›i',
        icon: 'document',
        color: '#10B981'
    },
    totalSubjects: {
        value: 48,
        previousValue: 44,
        growth: 8,
        label: 'MÃ´n há»c',
        icon: 'book',
        color: '#8B5CF6'
    }
};

// Dá»¯ liá»‡u tÄƒng trÆ°á»Ÿng theo thÃ¡ng (Area Chart)
const mockGrowthChart = [
    { label: 'T1', month: 'ThÃ¡ng 1', value: 150, users: 150, documents: 320, subjects: 12 },
    { label: 'T2', month: 'ThÃ¡ng 2', value: 230, users: 230, documents: 485, subjects: 18 },
    { label: 'T3', month: 'ThÃ¡ng 3', value: 380, users: 380, documents: 720, subjects: 24 },
    { label: 'T4', month: 'ThÃ¡ng 4', value: 450, users: 450, documents: 1050, subjects: 30 },
    { label: 'T5', month: 'ThÃ¡ng 5', value: 620, users: 620, documents: 1680, subjects: 36 },
    { label: 'T6', month: 'ThÃ¡ng 6', value: 810, users: 810, documents: 2240, subjects: 42 },
    { label: 'T7', month: 'ThÃ¡ng 7', value: 1024, users: 1024, documents: 2847, subjects: 48 }
];

// MÃ´n há»c phá»• biáº¿n (Popular Subjects)
const mockPopularSubjects = [
    { id: 1, name: 'Triáº¿t há»c', code: 'PHIL101', students: 456, color: '#3B82F6', trend: 'up', growth: 12 },
    { id: 2, name: 'ToÃ¡n rá»i ráº¡c', code: 'MATH201', students: 389, color: '#10B981', trend: 'up', growth: 8 },
    { id: 3, name: 'Láº­p trÃ¬nh C++', code: 'CS102', students: 342, color: '#F59E0B', trend: 'stable', growth: 2 },
    { id: 4, name: 'CÆ¡ sá»Ÿ dá»¯ liá»‡u', code: 'CS301', students: 298, color: '#8B5CF6', trend: 'up', growth: 15 },
    { id: 5, name: 'Tiáº¿ng Anh', code: 'ENG101', students: 267, color: '#EF4444', trend: 'down', growth: -3 }
];

// Hoáº¡t Ä‘á»™ng tuáº§n nÃ y (Weekly Activity - Bar Chart)
const mockWeeklyActivity = [
    { label: 'T2', day: 'Thá»© 2', value: 245, logins: 180, documents: 45, exams: 20 },
    { label: 'T3', day: 'Thá»© 3', value: 312, logins: 220, documents: 62, exams: 30 },
    { label: 'T4', day: 'Thá»© 4', value: 287, logins: 195, documents: 58, exams: 34 },
    { label: 'T5', day: 'Thá»© 5', value: 398, logins: 280, documents: 78, exams: 40 },
    { label: 'T6', day: 'Thá»© 6', value: 456, logins: 320, documents: 92, exams: 44 },
    { label: 'T7', day: 'Thá»© 7', value: 189, logins: 120, documents: 49, exams: 20 },
    { label: 'CN', day: 'Chá»§ nháº­t', value: 134, logins: 85, documents: 34, exams: 15 }
];

// Dá»¯ liá»‡u bá»• sung cho dashboard
const mockAdditionalStats = {
    // PhÃ¢n bá»‘ ngÆ°á»i dÃ¹ng theo thiáº¿t bá»‹
    deviceDistribution: [
        { label: 'Desktop', value: 45, count: 461 },
        { label: 'Mobile', value: 38, count: 389 },
        { label: 'Tablet', value: 17, count: 174 }
    ],
    // Thá»i gian há»c trung bÃ¬nh
    avgStudyTime: {
        daily: '2h 15m',
        weekly: '15h 45m',
        monthly: '62h 30m'
    },
    // Top ngÆ°á»i dÃ¹ng tÃ­ch cá»±c
    topActiveUsers: [
        { rank: 1, name: 'VÅ© Äá»©c Khang', studyTime: '65h 20m', badge: 'ðŸ†' },
        { rank: 2, name: 'LÃª HoÃ ng CÆ°á»ng', studyTime: '56h 08m', badge: 'ðŸ¥ˆ' },
        { rank: 3, name: 'Nguyá»…n VÄƒn Anh', studyTime: '42h 15m', badge: 'ðŸ¥‰' },
        { rank: 4, name: 'Tráº§n Thá»‹ BÃ¬nh', studyTime: '38h 42m', badge: '' },
        { rank: 5, name: 'HoÃ ng Thá»‹ HÆ°Æ¡ng', studyTime: '28h 55m', badge: '' }
    ],
    // Tá»· lá»‡ hoÃ n thÃ nh bÃ i táº­p
    completionRate: {
        exams: 78,
        flashcards: 65,
        documents: 82
    }
};

// ==================== STATISTICS API ENDPOINTS ====================

/**
 * GET /stats/overview
 * Tráº£ vá» 3 chá»‰ sá»‘ tá»•ng quan kÃ¨m pháº§n trÄƒm tÄƒng trÆ°á»Ÿng
 */
router.get('/stats/overview', (req, res) => {
    try {
        const { period = 'month' } = req.query;

        // Format dá»¯ liá»‡u cho frontend dá»… render
        const overview = {
            totalUsers: {
                ...mockOverviewStats.totalUsers,
                formatted: mockOverviewStats.totalUsers.value.toLocaleString(),
                growthText: `+${mockOverviewStats.totalUsers.growth}%`
            },
            newDocuments: {
                ...mockOverviewStats.newDocuments,
                formatted: mockOverviewStats.newDocuments.value.toLocaleString(),
                growthText: `+${mockOverviewStats.newDocuments.growth}%`
            },
            totalSubjects: {
                ...mockOverviewStats.totalSubjects,
                formatted: mockOverviewStats.totalSubjects.value.toLocaleString(),
                growthText: `+${mockOverviewStats.totalSubjects.growth}%`
            }
        };

        // TÃ­nh tá»•ng tÆ°Æ¡ng tÃ¡c
        const totalInteractions = mockWeeklyActivity.reduce((sum, day) => sum + day.value, 0);

        res.json({
            success: true,
            data: {
                metrics: overview,
                summary: {
                    totalInteractionsThisWeek: totalInteractions,
                    avgDailyInteractions: Math.round(totalInteractions / 7),
                    period: period
                }
            },
            message: 'Láº¥y dá»¯ liá»‡u tá»•ng quan thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching overview stats:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y dá»¯ liá»‡u tá»•ng quan'
        });
    }
});

/**
 * GET /stats/growth-chart
 * Tráº£ vá» máº£ng dá»¯ liá»‡u phá»¥c vá»¥ Area Chart
 */
router.get('/stats/growth-chart', (req, res) => {
    try {
        const { 
            metric = 'users',  // users, documents, subjects, all
            months = 7 
        } = req.query;

        let chartData = mockGrowthChart.slice(-parseInt(months));

        // Format theo metric Ä‘Æ°á»£c yÃªu cáº§u
        if (metric !== 'all') {
            chartData = chartData.map(item => ({
                label: item.label,
                month: item.month,
                value: item[metric] || item.value
            }));
        }

        // TÃ­nh cÃ¡c chá»‰ sá»‘ bá»• sung
        const values = chartData.map(d => d.value);
        const stats = {
            min: Math.min(...values),
            max: Math.max(...values),
            avg: Math.round(values.reduce((a, b) => a + b, 0) / values.length),
            total: values.reduce((a, b) => a + b, 0),
            growthRate: Math.round(((values[values.length - 1] - values[0]) / values[0]) * 100)
        };

        res.json({
            success: true,
            data: {
                chart: chartData,
                stats: stats,
                meta: {
                    metric: metric,
                    period: `${months} thÃ¡ng gáº§n nháº¥t`,
                    lastUpdated: new Date().toISOString()
                }
            },
            message: 'Láº¥y dá»¯ liá»‡u biá»ƒu Ä‘á»“ tÄƒng trÆ°á»Ÿng thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching growth chart:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y dá»¯ liá»‡u biá»ƒu Ä‘á»“'
        });
    }
});

/**
 * GET /stats/popular-subjects
 * Tráº£ vá» danh sÃ¡ch mÃ´n há»c vÃ  sá»‘ lÆ°á»£ng sinh viÃªn tÆ°Æ¡ng á»©ng
 */
router.get('/stats/popular-subjects', (req, res) => {
    try {
        const { 
            limit = 5,
            sortBy = 'students',  // students, growth, name
            order = 'desc'
        } = req.query;

        let subjects = [...mockPopularSubjects];

        // Sáº¯p xáº¿p
        subjects.sort((a, b) => {
            let comparison = 0;
            if (sortBy === 'students') {
                comparison = a.students - b.students;
            } else if (sortBy === 'growth') {
                comparison = a.growth - b.growth;
            } else if (sortBy === 'name') {
                comparison = a.name.localeCompare(b.name);
            }
            return order === 'desc' ? -comparison : comparison;
        });

        // Giá»›i háº¡n sá»‘ lÆ°á»£ng
        subjects = subjects.slice(0, parseInt(limit));

        // TÃ­nh tá»•ng sinh viÃªn
        const totalStudents = mockPopularSubjects.reduce((sum, s) => sum + s.students, 0);

        // Format cho chart (pie/bar)
        const chartData = subjects.map((s, index) => ({
            label: s.name,
            value: s.students,
            percentage: Math.round((s.students / totalStudents) * 100),
            color: s.color,
            rank: index + 1
        }));

        res.json({
            success: true,
            data: {
                subjects: subjects,
                chartData: chartData,
                summary: {
                    totalSubjects: mockPopularSubjects.length,
                    totalStudents: totalStudents,
                    avgStudentsPerSubject: Math.round(totalStudents / mockPopularSubjects.length)
                }
            },
            message: 'Láº¥y danh sÃ¡ch mÃ´n há»c phá»• biáº¿n thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching popular subjects:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch mÃ´n há»c'
        });
    }
});

/**
 * GET /stats/weekly-activity
 * Tráº£ vá» dá»¯ liá»‡u lÆ°á»£ng hoáº¡t Ä‘á»™ng theo tá»«ng ngÃ y trong tuáº§n
 */
router.get('/stats/weekly-activity', (req, res) => {
    try {
        const { 
            breakdown = false,  // true Ä‘á»ƒ láº¥y chi tiáº¿t logins/documents/exams
            week = 'current'    // current, previous
        } = req.query;

        let activityData = [...mockWeeklyActivity];

        // Simulate previous week data (giáº£m ~15%)
        if (week === 'previous') {
            activityData = activityData.map(day => ({
                ...day,
                value: Math.round(day.value * 0.85),
                logins: Math.round(day.logins * 0.85),
                documents: Math.round(day.documents * 0.85),
                exams: Math.round(day.exams * 0.85)
            }));
        }

        // Format dá»¯ liá»‡u
        let responseData;
        if (breakdown === 'true' || breakdown === true) {
            responseData = activityData;
        } else {
            responseData = activityData.map(day => ({
                label: day.label,
                day: day.day,
                value: day.value
            }));
        }

        // TÃ­nh toÃ¡n stats
        const values = activityData.map(d => d.value);
        const stats = {
            total: values.reduce((a, b) => a + b, 0),
            average: Math.round(values.reduce((a, b) => a + b, 0) / values.length),
            peak: {
                day: activityData.find(d => d.value === Math.max(...values)).day,
                value: Math.max(...values)
            },
            lowest: {
                day: activityData.find(d => d.value === Math.min(...values)).day,
                value: Math.min(...values)
            }
        };

        // So sÃ¡nh vá»›i tuáº§n trÆ°á»›c
        const previousWeekTotal = Math.round(stats.total * 0.85);
        const weeklyGrowth = Math.round(((stats.total - previousWeekTotal) / previousWeekTotal) * 100);

        res.json({
            success: true,
            data: {
                activity: responseData,
                stats: {
                    ...stats,
                    previousWeekTotal: previousWeekTotal,
                    weeklyGrowth: weeklyGrowth,
                    growthText: weeklyGrowth >= 0 ? `+${weeklyGrowth}%` : `${weeklyGrowth}%`
                },
                meta: {
                    week: week,
                    hasBreakdown: breakdown === 'true' || breakdown === true
                }
            },
            message: 'Láº¥y dá»¯ liá»‡u hoáº¡t Ä‘á»™ng tuáº§n thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching weekly activity:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y dá»¯ liá»‡u hoáº¡t Ä‘á»™ng'
        });
    }
});

/**
 * GET /stats/dashboard
 * Endpoint tá»•ng há»£p - Láº¥y táº¥t cáº£ dá»¯ liá»‡u cho Dashboard Admin
 */
router.get('/stats/dashboard', (req, res) => {
    try {
        // Tá»•ng há»£p táº¥t cáº£ dá»¯ liá»‡u cho dashboard
        const dashboardData = {
            overview: {
                totalUsers: mockOverviewStats.totalUsers,
                newDocuments: mockOverviewStats.newDocuments,
                totalSubjects: mockOverviewStats.totalSubjects
            },
            growthChart: mockGrowthChart,
            popularSubjects: mockPopularSubjects.slice(0, 5),
            weeklyActivity: mockWeeklyActivity,
            additional: mockAdditionalStats
        };

        res.json({
            success: true,
            data: dashboardData,
            message: 'Láº¥y dá»¯ liá»‡u dashboard thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching dashboard data:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y dá»¯ liá»‡u dashboard'
        });
    }
});

/**
 * GET /stats/device-distribution
 * PhÃ¢n bá»‘ ngÆ°á»i dÃ¹ng theo thiáº¿t bá»‹
 */
router.get('/stats/device-distribution', (req, res) => {
    try {
        const chartData = mockAdditionalStats.deviceDistribution.map(d => ({
            label: d.label,
            value: d.value,
            count: d.count
        }));

        res.json({
            success: true,
            data: {
                distribution: chartData,
                total: chartData.reduce((sum, d) => sum + d.count, 0)
            },
            message: 'Láº¥y phÃ¢n bá»‘ thiáº¿t bá»‹ thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching device distribution:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y phÃ¢n bá»‘ thiáº¿t bá»‹'
        });
    }
});

/**
 * GET /stats/top-users
 * Top ngÆ°á»i dÃ¹ng tÃ­ch cá»±c nháº¥t
 */
router.get('/stats/top-users', (req, res) => {
    try {
        const { limit = 5 } = req.query;

        res.json({
            success: true,
            data: {
                users: mockAdditionalStats.topActiveUsers.slice(0, parseInt(limit)),
                avgStudyTime: mockAdditionalStats.avgStudyTime
            },
            message: 'Láº¥y top users thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching top users:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y top users'
        });
    }
});

// ==================== DATABASE BACKUP MODULE ====================
// Module Sao lÆ°u há»‡ thá»‘ng - Quáº£n lÃ½ backup, restore vÃ  cáº¥u hÃ¬nh tá»± Ä‘á»™ng

const fs = require('fs');
const path = require('path');

// ==================== BACKUP MOCK DATA ====================

// Danh sÃ¡ch cÃ¡c báº£n backup hiá»‡n cÃ³
let mockBackups = [
    {
        id: 1,
        filename: 'backup_20260220_0300.sql',
        filepath: '/backups/backup_20260220_0300.sql',
        size: 2576980377, // 2.4 GB in bytes
        sizeFormatted: '2.4 GB',
        type: 'Tá»± Ä‘á»™ng',
        status: 'HoÃ n táº¥t',
        createdAt: '2026-02-20T03:00:00Z',
        createdBy: 'System Auto Backup',
        duration: '2m 15s',
        tables: 15,
        records: 125847,
        compression: 'gzip'
    },
    {
        id: 2,
        filename: 'backup_20260219_0300.sql',
        filepath: '/backups/backup_20260219_0300.sql',
        size: 2469606195, // 2.3 GB in bytes
        sizeFormatted: '2.3 GB',
        type: 'Tá»± Ä‘á»™ng',
        status: 'HoÃ n táº¥t',
        createdAt: '2026-02-19T03:00:00Z',
        createdBy: 'System Auto Backup',
        duration: '2m 08s',
        tables: 15,
        records: 122340,
        compression: 'gzip'
    },
    {
        id: 3,
        filename: 'backup_manual_preupdate.sql',
        filepath: '/backups/backup_manual_preupdate.sql',
        size: 2362232012, // 2.2 GB in bytes
        sizeFormatted: '2.2 GB',
        type: 'Thá»§ cÃ´ng',
        status: 'HoÃ n táº¥t',
        createdAt: '2026-02-18T14:30:00Z',
        createdBy: 'Admin Whalio',
        duration: '1m 58s',
        tables: 15,
        records: 118560,
        compression: 'gzip'
    },
    {
        id: 4,
        filename: 'backup_20260218_0300.sql',
        filepath: '/backups/backup_20260218_0300.sql',
        size: 2347661926, // 2.19 GB
        sizeFormatted: '2.19 GB',
        type: 'Tá»± Ä‘á»™ng',
        status: 'HoÃ n táº¥t',
        createdAt: '2026-02-18T03:00:00Z',
        createdBy: 'System Auto Backup',
        duration: '2m 05s',
        tables: 15,
        records: 117892,
        compression: 'gzip'
    },
    {
        id: 5,
        filename: 'backup_20260217_0300.sql',
        filepath: '/backups/backup_20260217_0300.sql',
        size: 2315255398, // 2.16 GB
        sizeFormatted: '2.16 GB',
        type: 'Tá»± Ä‘á»™ng',
        status: 'HoÃ n táº¥t',
        createdAt: '2026-02-17T03:00:00Z',
        createdBy: 'System Auto Backup',
        duration: '2m 12s',
        tables: 15,
        records: 115430,
        compression: 'gzip'
    }
];

// Cáº¥u hÃ¬nh backup tá»± Ä‘á»™ng
let backupSettings = {
    autoBackup: true,
    schedule: 'HÃ ng ngÃ y 03:00',
    scheduleCron: '0 3 * * *',
    retentionDays: 30,
    storageLocation: '/backups',
    compression: true,
    emailNotification: true,
    notificationEmail: 'admin@whalio.edu.vn',
    maxBackups: 10,
    backupOnDeploy: true
};

// Thá»‘ng kÃª backup
const backupStats = {
    totalBackups: mockBackups.length,
    lastBackupDate: '20/02/2026 03:00',
    totalSize: mockBackups.reduce((sum, b) => sum + b.size, 0),
    autoBackupsCount: mockBackups.filter(b => b.type === 'Tá»± Ä‘á»™ng').length,
    manualBackupsCount: mockBackups.filter(b => b.type === 'Thá»§ cÃ´ng').length,
    successRate: 100,
    avgDuration: '2m 07s'
};

// ==================== BACKUP API ENDPOINTS ====================

/**
 * GET /backups
 * Tráº£ vá» danh sÃ¡ch cÃ¡c báº£n backup vÃ  cáº¥u hÃ¬nh hiá»‡n táº¡i
 */
router.get('/backups', (req, res) => {
    try {
        const { 
            type = 'all',        // all, auto, manual
            sortBy = 'date',     // date, size, type
            order = 'desc',
            limit = 10,
            page = 1
        } = req.query;

        let filteredBackups = [...mockBackups];

        // Lá»c theo loáº¡i
        if (type !== 'all') {
            const typeMap = {
                'auto': 'Tá»± Ä‘á»™ng',
                'manual': 'Thá»§ cÃ´ng'
            };
            filteredBackups = filteredBackups.filter(b => b.type === typeMap[type]);
        }

        // Sáº¯p xáº¿p
        filteredBackups.sort((a, b) => {
            let comparison = 0;
            if (sortBy === 'date') {
                comparison = new Date(a.createdAt) - new Date(b.createdAt);
            } else if (sortBy === 'size') {
                comparison = a.size - b.size;
            } else if (sortBy === 'type') {
                comparison = a.type.localeCompare(b.type);
            }
            return order === 'desc' ? -comparison : comparison;
        });

        // PhÃ¢n trang
        const startIndex = (parseInt(page) - 1) * parseInt(limit);
        const endIndex = startIndex + parseInt(limit);
        const paginatedBackups = filteredBackups.slice(startIndex, endIndex);

        // Cáº­p nháº­t stats
        const currentStats = {
            ...backupStats,
            totalBackups: mockBackups.length,
            totalSize: mockBackups.reduce((sum, b) => sum + b.size, 0),
            totalSizeFormatted: formatBytes(mockBackups.reduce((sum, b) => sum + b.size, 0))
        };

        res.json({
            success: true,
            data: {
                backups: paginatedBackups,
                settings: backupSettings,
                stats: currentStats,
                pagination: {
                    currentPage: parseInt(page),
                    totalPages: Math.ceil(filteredBackups.length / parseInt(limit)),
                    totalItems: filteredBackups.length
                }
            },
            message: 'Láº¥y danh sÃ¡ch backup thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching backups:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y danh sÃ¡ch backup'
        });
    }
});

/**
 * POST /backups/create
 * Táº¡o báº£n backup thá»§ cÃ´ng
 */
router.post('/backups/create', (req, res) => {
    try {
        const { description = 'Manual backup', includeUploads = true } = req.body;

        console.log('ðŸ”„ Äang táº¡o báº£n sao lÆ°u thá»§ cÃ´ng...');
        
        // Táº¡o tÃªn file backup
        const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace('T', '_').split('.')[0];
        const filename = `backup_manual_${timestamp}.sql`;

        // Giáº£ láº­p tiáº¿n trÃ¬nh backup
        console.log(`ðŸ“¦ Dumping database to ${filename}...`);
        console.log('â³ Compressing with gzip...');
        
        // Simulate backup process (trong thá»±c táº¿ sáº½ cháº¡y mongodump hoáº·c mysqldump)
        // const { exec } = require('child_process');
        // exec('mongodump --uri="mongodb://..." --archive --gzip', callback);

        // Táº¡o báº£n ghi backup má»›i
        const newBackup = {
            id: mockBackups.length + 1,
            filename: filename,
            filepath: `/backups/${filename}`,
            size: 2600000000 + Math.floor(Math.random() * 100000000), // Random ~2.6GB
            sizeFormatted: '', // Will be set below
            type: 'Thá»§ cÃ´ng',
            status: 'HoÃ n táº¥t',
            createdAt: new Date().toISOString(),
            createdBy: 'Admin Whalio',
            duration: '2m 05s',
            tables: 15,
            records: mockBackups[0].records + Math.floor(Math.random() * 1000),
            compression: 'gzip',
            description: description,
            includeUploads: includeUploads
        };

        newBackup.sizeFormatted = formatBytes(newBackup.size);

        // ThÃªm vÃ o Ä‘áº§u danh sÃ¡ch
        mockBackups.unshift(newBackup);

        // XÃ³a backup cÅ© náº¿u vÆ°á»£t quÃ¡ maxBackups
        if (mockBackups.length > backupSettings.maxBackups) {
            const removed = mockBackups.pop();
            console.log(`ðŸ—‘ï¸  ÄÃ£ xÃ³a backup cÅ©: ${removed.filename} (vÆ°á»£t quÃ¡ giá»›i háº¡n ${backupSettings.maxBackups})`);
        }

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'backup',
            severity: 'success',
            title: 'Backup thá»§ cÃ´ng hoÃ n táº¥t',
            description: `ÄÃ£ táº¡o ${filename} - ${newBackup.sizeFormatted}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: newBackup
        });

        console.log(`âœ… Backup hoÃ n táº¥t: ${filename}`);

        res.json({
            success: true,
            data: newBackup,
            message: `ÄÃ£ táº¡o báº£n sao lÆ°u thá»§ cÃ´ng thÃ nh cÃ´ng: ${filename}`
        });

    } catch (error) {
        console.error('âŒ Error creating backup:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi táº¡o báº£n sao lÆ°u'
        });
    }
});

/**
 * GET /backups/download/:filename
 * Táº£i xuá»‘ng file backup
 */
router.get('/backups/download/:filename', (req, res) => {
    try {
        const { filename } = req.params;

        // TÃ¬m backup trong danh sÃ¡ch
        const backup = mockBackups.find(b => b.filename === filename);

        if (!backup) {
            return res.status(404).json({
                success: false,
                data: null,
                message: 'KhÃ´ng tÃ¬m tháº¥y file backup'
            });
        }

        console.log(`ðŸ“¥ Admin Ä‘ang táº£i xuá»‘ng file [${filename}]`);
        console.log(`   Size: ${backup.sizeFormatted}`);
        console.log(`   Type: ${backup.type}`);

        // Trong thá»±c táº¿ sáº½ gá»­i file stream
        // const filePath = path.join(__dirname, '../../backups', filename);
        // res.download(filePath, filename);

        // Mock response
        res.json({
            success: true,
            data: {
                filename: backup.filename,
                size: backup.size,
                sizeFormatted: backup.sizeFormatted,
                downloadUrl: `/downloads/backups/${filename}`,
                expiresIn: '15 minutes'
            },
            message: `Äang chuáº©n bá»‹ táº£i xuá»‘ng ${filename}`
        });

    } catch (error) {
        console.error('âŒ Error downloading backup:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi táº£i xuá»‘ng backup'
        });
    }
});

/**
 * DELETE /backups/:filename
 * XÃ³a báº£n backup
 */
router.delete('/backups/:filename', (req, res) => {
    try {
        const { filename } = req.params;

        // TÃ¬m index cá»§a backup
        const backupIndex = mockBackups.findIndex(b => b.filename === filename);

        if (backupIndex === -1) {
            return res.status(404).json({
                success: false,
                data: null,
                message: 'KhÃ´ng tÃ¬m tháº¥y file backup'
            });
        }

        const deletedBackup = mockBackups[backupIndex];

        // KhÃ´ng cho phÃ©p xÃ³a backup má»›i nháº¥t
        if (backupIndex === 0 && mockBackups.length > 1) {
            return res.status(403).json({
                success: false,
                data: null,
                message: 'KhÃ´ng thá»ƒ xÃ³a backup má»›i nháº¥t. Vui lÃ²ng giá»¯ Ã­t nháº¥t má»™t báº£n backup gáº§n Ä‘Ã¢y.'
            });
        }

        // XÃ³a khá»i danh sÃ¡ch
        mockBackups.splice(backupIndex, 1);

        console.log(`ðŸ—‘ï¸  ÄÃ£ xÃ³a báº£n sao lÆ°u [${filename}]`);
        console.log(`   Released space: ${deletedBackup.sizeFormatted}`);

        // Trong thá»±c táº¿ sáº½ xÃ³a file tháº­t
        // const filePath = path.join(__dirname, '../../backups', filename);
        // fs.unlinkSync(filePath);

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: 'info',
            title: 'Backup Ä‘Ã£ xÃ³a',
            description: `ÄÃ£ xÃ³a ${filename}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: { filename, size: deletedBackup.sizeFormatted }
        });

        res.json({
            success: true,
            data: {
                deletedFile: filename,
                freedSpace: deletedBackup.sizeFormatted,
                remainingBackups: mockBackups.length
            },
            message: `ÄÃ£ xÃ³a báº£n sao lÆ°u ${filename}`
        });

    } catch (error) {
        console.error('âŒ Error deleting backup:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi xÃ³a backup'
        });
    }
});

/**
 * PUT /backups/settings
 * Cáº­p nháº­t cáº¥u hÃ¬nh backup tá»± Ä‘á»™ng
 */
router.put('/backups/settings', (req, res) => {
    try {
        const {
            autoBackup,
            retentionDays,
            schedule,
            compression,
            emailNotification,
            notificationEmail,
            maxBackups,
            backupOnDeploy
        } = req.body;

        // LÆ°u settings cÅ© Ä‘á»ƒ so sÃ¡nh
        const oldSettings = { ...backupSettings };

        // Cáº­p nháº­t settings
        if (typeof autoBackup !== 'undefined') {
            backupSettings.autoBackup = autoBackup;
        }
        if (retentionDays) {
            backupSettings.retentionDays = parseInt(retentionDays);
        }
        if (schedule) {
            backupSettings.schedule = schedule;
        }
        if (typeof compression !== 'undefined') {
            backupSettings.compression = compression;
        }
        if (typeof emailNotification !== 'undefined') {
            backupSettings.emailNotification = emailNotification;
        }
        if (notificationEmail) {
            backupSettings.notificationEmail = notificationEmail;
        }
        if (maxBackups) {
            backupSettings.maxBackups = parseInt(maxBackups);
        }
        if (typeof backupOnDeploy !== 'undefined') {
            backupSettings.backupOnDeploy = backupOnDeploy;
        }

        // Log thay Ä‘á»•i
        console.log('âš™ï¸  ÄÃ£ cáº­p nháº­t cáº¥u hÃ¬nh backup:');
        console.log(`   Auto Backup: ${oldSettings.autoBackup} â†’ ${backupSettings.autoBackup}`);
        console.log(`   Retention: ${oldSettings.retentionDays} ngÃ y â†’ ${backupSettings.retentionDays} ngÃ y`);
        console.log(`   Schedule: ${backupSettings.schedule}`);

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: 'info',
            title: 'Cáº¥u hÃ¬nh backup Ä‘Ã£ thay Ä‘á»•i',
            description: `Auto backup: ${backupSettings.autoBackup ? 'Báº¬T' : 'Táº®T'}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: { oldSettings, newSettings: backupSettings }
        });

        res.json({
            success: true,
            data: backupSettings,
            message: 'ÄÃ£ cáº­p nháº­t cáº¥u hÃ¬nh backup thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error updating backup settings:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi cáº­p nháº­t cáº¥u hÃ¬nh'
        });
    }
});

/**
 * POST /backups/restore/:filename
 * KhÃ´i phá»¥c database tá»« báº£n backup
 */
router.post('/backups/restore/:filename', (req, res) => {
    try {
        const { filename } = req.params;
        const { confirmRestore } = req.body;

        // TÃ¬m backup
        const backup = mockBackups.find(b => b.filename === filename);

        if (!backup) {
            return res.status(404).json({
                success: false,
                data: null,
                message: 'KhÃ´ng tÃ¬m tháº¥y file backup'
            });
        }

        // YÃªu cáº§u xÃ¡c nháº­n
        if (!confirmRestore) {
            return res.status(400).json({
                success: false,
                data: {
                    backup: backup,
                    warning: 'KhÃ´i phá»¥c sáº½ ghi Ä‘Ã¨ toÃ n bá»™ dá»¯ liá»‡u hiá»‡n táº¡i!'
                },
                message: 'Vui lÃ²ng xÃ¡c nháº­n khÃ´i phá»¥c báº±ng { confirmRestore: true }'
            });
        }

        console.log(`ðŸ”„ Báº¯t Ä‘áº§u khÃ´i phá»¥c tá»« ${filename}...`);
        console.log(`âš ï¸  Cáº¢NH BÃO: Äang ghi Ä‘Ã¨ dá»¯ liá»‡u hiá»‡n táº¡i!`);

        // Trong thá»±c táº¿ sáº½ cháº¡y mongorestore hoáº·c mysql
        // exec(`mongorestore --archive=${filepath} --gzip --drop`, callback);

        // Simulate restore process
        const restoreResult = {
            filename: backup.filename,
            restoredAt: new Date().toISOString(),
            tables: backup.tables,
            records: backup.records,
            size: backup.sizeFormatted,
            duration: '3m 20s',
            status: 'completed'
        };

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: 'warning',
            title: 'Database Restored',
            description: `ÄÃ£ khÃ´i phá»¥c tá»« ${filename}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: restoreResult
        });

        console.log(`âœ… KhÃ´i phá»¥c hoÃ n táº¥t tá»« ${filename}`);

        res.json({
            success: true,
            data: restoreResult,
            message: `ÄÃ£ khÃ´i phá»¥c database thÃ nh cÃ´ng tá»« ${filename}`
        });

    } catch (error) {
        console.error('âŒ Error restoring backup:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi khÃ´i phá»¥c backup'
        });
    }
});

/**
 * GET /backups/stats
 * Thá»‘ng kÃª backup
 */
router.get('/backups/stats', (req, res) => {
    try {
        const stats = {
            ...backupStats,
            totalBackups: mockBackups.length,
            totalSize: mockBackups.reduce((sum, b) => sum + b.size, 0),
            totalSizeFormatted: formatBytes(mockBackups.reduce((sum, b) => sum + b.size, 0)),
            autoBackupsCount: mockBackups.filter(b => b.type === 'Tá»± Ä‘á»™ng').length,
            manualBackupsCount: mockBackups.filter(b => b.type === 'Thá»§ cÃ´ng').length,
            lastBackup: mockBackups[0],
            oldestBackup: mockBackups[mockBackups.length - 1]
        };

        res.json({
            success: true,
            data: stats,
            message: 'Láº¥y thá»‘ng kÃª backup thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching backup stats:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y thá»‘ng kÃª backup'
        });
    }
});

// ==================== MAINTENANCE MODULE ====================
// Module Báº£o trÃ¬ há»‡ thá»‘ng - Kiá»ƒm soÃ¡t cháº¿ Ä‘á»™ maintenance vÃ  lá»‹ch trÃ¬nh

// ==================== MAINTENANCE STATUS ====================
/**
 * Object toÃ n cá»¥c lÆ°u trá»¯ tráº¡ng thÃ¡i báº£o trÃ¬
 * Trong production sáº½ lÆ°u vÃ o database
 */
let maintenanceStatus = {
    isEnabled: false,
    scheduledDate: '21/02/2026',
    startTime: '03:00',
    endTime: '05:00',
    duration: 2, // giá»
    message: 'ChÃºng tÃ´i sáº½ nÃ¢ng cáº¥p há»‡ thá»‘ng Ä‘á»ƒ mang Ä‘áº¿n tráº£i nghiá»‡m tá»‘t hÆ¡n. Vui lÃ²ng quay láº¡i sau.',
    reason: 'NÃ¢ng cáº¥p server vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u',
    affectedServices: ['API', 'Database', 'File Upload'],
    contactEmail: 'admin@whalio.edu.vn',
    estimatedDowntime: '2 giá»',
    lastUpdatedBy: 'System',
    lastUpdatedAt: '2026-02-21T00:00:00Z',
    history: []
};

// ==================== MAINTENANCE MIDDLEWARE ====================
/**
 * Middleware kiá»ƒm tra cháº¿ Ä‘á»™ báº£o trÃ¬
 * Cháº·n má»i request tá»« user thÆ°á»ng khi isEnabled = true
 * Admin váº«n cÃ³ thá»ƒ truy cáº­p
 */
function maintenanceCheck(req, res, next) {
    // Kiá»ƒm tra náº¿u Ä‘ang trong cháº¿ Ä‘á»™ báº£o trÃ¬
    if (maintenanceStatus.isEnabled) {
        // Cho phÃ©p Admin bypass (kiá»ƒm tra qua header hoáº·c path)
        const isAdminPath = req.path.startsWith('/api/admin');
        const isAuthPath = req.path.startsWith('/api/auth');
        
        // Admin vÃ  auth endpoints Ä‘Æ°á»£c bypass
        if (isAdminPath || isAuthPath) {
            return next();
        }

        // Cháº·n user thÆ°á»ng, tráº£ vá» 503 Service Unavailable
        return res.status(503).json({
            success: false,
            data: {
                maintenance: true,
                scheduledDate: maintenanceStatus.scheduledDate,
                startTime: maintenanceStatus.startTime,
                endTime: maintenanceStatus.endTime,
                duration: `${maintenanceStatus.duration} giá»`,
                estimatedDowntime: maintenanceStatus.estimatedDowntime,
                affectedServices: maintenanceStatus.affectedServices,
                contactEmail: maintenanceStatus.contactEmail
            },
            message: maintenanceStatus.message
        });
    }

    // KhÃ´ng trong cháº¿ Ä‘á»™ báº£o trÃ¬, cho phÃ©p request tiáº¿p tá»¥c
    next();
}

// ==================== MAINTENANCE API ENDPOINTS ====================

/**
 * GET /maintenance
 * Láº¥y tráº¡ng thÃ¡i báº£o trÃ¬ hiá»‡n táº¡i vÃ  lá»‹ch trÃ¬nh
 */
router.get('/maintenance', (req, res) => {
    try {
        // TÃ­nh toÃ¡n thá»i gian cÃ²n láº¡i náº¿u Ä‘ang báº£o trÃ¬
        let timeRemaining = null;
        let isActive = false;

        if (maintenanceStatus.isEnabled) {
            // Parse scheduled time
            const [day, month, year] = maintenanceStatus.scheduledDate.split('/');
            const [hours, minutes] = maintenanceStatus.startTime.split(':');
            const startDate = new Date(year, month - 1, day, hours, minutes);
            const endDate = new Date(startDate.getTime() + maintenanceStatus.duration * 60 * 60 * 1000);
            const now = new Date();

            if (now >= startDate && now <= endDate) {
                isActive = true;
                const remainingMs = endDate - now;
                const remainingHours = Math.floor(remainingMs / (1000 * 60 * 60));
                const remainingMinutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                timeRemaining = `${remainingHours}h ${remainingMinutes}m`;
            }
        }

        res.json({
            success: true,
            data: {
                ...maintenanceStatus,
                isActive: isActive,
                timeRemaining: timeRemaining,
                totalScheduled: maintenanceStatus.history.length
            },
            message: 'Láº¥y tráº¡ng thÃ¡i báº£o trÃ¬ thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching maintenance status:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y tráº¡ng thÃ¡i báº£o trÃ¬'
        });
    }
});

/**
 * PUT /maintenance/toggle
 * Báº­t/táº¯t cháº¿ Ä‘á»™ báº£o trÃ¬ kháº©n cáº¥p
 */
router.put('/maintenance/toggle', (req, res) => {
    try {
        const previousState = maintenanceStatus.isEnabled;
        maintenanceStatus.isEnabled = !previousState;
        
        const newState = maintenanceStatus.isEnabled;
        
        console.log(`ðŸš¨ Tráº¡ng thÃ¡i báº£o trÃ¬ kháº©n cáº¥p Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn sang [${newState}]`);
        
        if (newState) {
            console.log('âš ï¸  Há»† THá»NG ÄANG TRONG CHáº¾ Äá»˜ Báº¢O TRÃŒ KHáº¨N Cáº¤P');
            console.log(`   Message: ${maintenanceStatus.message}`);
            console.log(`   Scheduled: ${maintenanceStatus.scheduledDate} ${maintenanceStatus.startTime}`);
        } else {
            console.log('âœ… Há»‡ thá»‘ng Ä‘Ã£ thoÃ¡t cháº¿ Ä‘á»™ báº£o trÃ¬');
        }

        // Cáº­p nháº­t thá»i gian vÃ  ngÆ°á»i thá»±c hiá»‡n
        maintenanceStatus.lastUpdatedAt = new Date().toISOString();
        maintenanceStatus.lastUpdatedBy = 'Admin Whalio';

        // ThÃªm vÃ o lá»‹ch sá»­
        maintenanceStatus.history.push({
            action: newState ? 'enabled' : 'disabled',
            type: 'emergency',
            timestamp: new Date().toISOString(),
            performedBy: 'Admin Whalio'
        });

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: newState ? 'warning' : 'success',
            title: newState ? 'Báº£o trÃ¬ KHáº¨N Cáº¤P Ä‘Ã£ Báº¬T' : 'Báº£o trÃ¬ Ä‘Ã£ Táº®T',
            description: newState 
                ? `Há»‡ thá»‘ng Ä‘ang trong cháº¿ Ä‘á»™ báº£o trÃ¬ kháº©n cáº¥p` 
                : 'Há»‡ thá»‘ng Ä‘Ã£ hoáº¡t Ä‘á»™ng trá»Ÿ láº¡i bÃ¬nh thÆ°á»ng',
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: { 
                previousState, 
                newState,
                message: maintenanceStatus.message
            }
        });

        res.json({
            success: true,
            data: {
                isEnabled: maintenanceStatus.isEnabled,
                previousState: previousState,
                message: maintenanceStatus.message,
                toggledAt: maintenanceStatus.lastUpdatedAt
            },
            message: newState 
                ? 'ÄÃ£ Báº¬T cháº¿ Ä‘á»™ báº£o trÃ¬ kháº©n cáº¥p. NgÆ°á»i dÃ¹ng sáº½ bá»‹ cháº·n truy cáº­p.' 
                : 'ÄÃ£ Táº®T cháº¿ Ä‘á»™ báº£o trÃ¬. Há»‡ thá»‘ng hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.'
        });

    } catch (error) {
        console.error('âŒ Error toggling maintenance:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi chuyá»ƒn Ä‘á»•i tráº¡ng thÃ¡i báº£o trÃ¬'
        });
    }
});

/**
 * POST /maintenance/schedule
 * LÃªn lá»‹ch báº£o trÃ¬ há»‡ thá»‘ng
 */
router.post('/maintenance/schedule', (req, res) => {
    try {
        const {
            scheduledDate,
            startTime,
            duration,
            message,
            reason,
            affectedServices,
            contactEmail,
            autoEnable
        } = req.body;

        // Validate input
        if (!scheduledDate || !startTime || !duration) {
            return res.status(400).json({
                success: false,
                data: null,
                message: 'Vui lÃ²ng cung cáº¥p Ä‘áº§y Ä‘á»§ thÃ´ng tin: ngÃ y, giá», thá»i lÆ°á»£ng'
            });
        }

        // Validate date format (dd/mm/yyyy)
        const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!dateRegex.test(scheduledDate)) {
            return res.status(400).json({
                success: false,
                data: null,
                message: 'Äá»‹nh dáº¡ng ngÃ y khÃ´ng Ä‘Ãºng. Vui lÃ²ng sá»­ dá»¥ng dd/mm/yyyy'
            });
        }

        // Validate time format (HH:MM)
        const timeRegex = /^\d{2}:\d{2}$/;
        if (!timeRegex.test(startTime)) {
            return res.status(400).json({
                success: false,
                data: null,
                message: 'Äá»‹nh dáº¡ng giá» khÃ´ng Ä‘Ãºng. Vui lÃ²ng sá»­ dá»¥ng HH:MM'
            });
        }

        // TÃ­nh endTime
        const [hours, minutes] = startTime.split(':');
        const startHour = parseInt(hours);
        const endHour = (startHour + parseInt(duration)) % 24;
        const endTime = `${String(endHour).padStart(2, '0')}:${minutes}`;

        // LÆ°u previous schedule Ä‘á»ƒ log
        const previousSchedule = { ...maintenanceStatus };

        // Cáº­p nháº­t maintenance status
        maintenanceStatus.scheduledDate = scheduledDate;
        maintenanceStatus.startTime = startTime;
        maintenanceStatus.endTime = endTime;
        maintenanceStatus.duration = parseInt(duration);
        maintenanceStatus.estimatedDowntime = `${duration} giá»`;
        
        if (message) maintenanceStatus.message = message;
        if (reason) maintenanceStatus.reason = reason;
        if (affectedServices) maintenanceStatus.affectedServices = affectedServices;
        if (contactEmail) maintenanceStatus.contactEmail = contactEmail;
        
        maintenanceStatus.lastUpdatedAt = new Date().toISOString();
        maintenanceStatus.lastUpdatedBy = 'Admin Whalio';

        // Tá»± Ä‘á»™ng báº­t náº¿u Ä‘Æ°á»£c yÃªu cáº§u
        if (autoEnable) {
            maintenanceStatus.isEnabled = true;
            console.log('ðŸš¨ Cháº¿ Ä‘á»™ báº£o trÃ¬ Ä‘Ã£ Ä‘Æ°á»£c Báº¬T tá»± Ä‘á»™ng');
        }

        // ThÃªm vÃ o lá»‹ch sá»­
        maintenanceStatus.history.push({
            action: 'scheduled',
            type: 'planned',
            scheduledDate: scheduledDate,
            startTime: startTime,
            duration: duration,
            timestamp: new Date().toISOString(),
            performedBy: 'Admin Whalio'
        });

        console.log('ðŸ“… Lá»‹ch báº£o trÃ¬ Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p:');
        console.log(`   NgÃ y: ${scheduledDate}`);
        console.log(`   Thá»i gian: ${startTime} - ${endTime}`);
        console.log(`   Thá»i lÆ°á»£ng: ${duration} giá»`);
        console.log(`   LÃ½ do: ${reason || maintenanceStatus.reason}`);
        console.log('   âœ… Sáº½ thÃ´ng bÃ¡o Ä‘áº¿n ngÆ°á»i dÃ¹ng');

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: 'info',
            title: 'Lá»‹ch báº£o trÃ¬ Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p',
            description: `Báº£o trÃ¬ vÃ o ${scheduledDate} lÃºc ${startTime} (${duration}h)`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: {
                scheduledDate,
                startTime,
                endTime,
                duration,
                reason: reason || maintenanceStatus.reason
            }
        });

        res.json({
            success: true,
            data: {
                scheduledDate: maintenanceStatus.scheduledDate,
                startTime: maintenanceStatus.startTime,
                endTime: maintenanceStatus.endTime,
                duration: maintenanceStatus.duration,
                message: maintenanceStatus.message,
                reason: maintenanceStatus.reason,
                affectedServices: maintenanceStatus.affectedServices,
                isEnabled: maintenanceStatus.isEnabled,
                autoEnabled: autoEnable || false
            },
            message: 'Lá»‹ch báº£o trÃ¬ Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p vÃ  sáº½ thÃ´ng bÃ¡o Ä‘áº¿n ngÆ°á»i dÃ¹ng'
        });

    } catch (error) {
        console.error('âŒ Error scheduling maintenance:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi thiáº¿t láº­p lá»‹ch báº£o trÃ¬'
        });
    }
});

/**
 * DELETE /maintenance/schedule
 * Há»§y lá»‹ch báº£o trÃ¬ Ä‘Ã£ lÃªn
 */
router.delete('/maintenance/schedule', (req, res) => {
    try {
        // LÆ°u lá»‹ch cÅ© Ä‘á»ƒ log
        const cancelledSchedule = {
            scheduledDate: maintenanceStatus.scheduledDate,
            startTime: maintenanceStatus.startTime,
            duration: maintenanceStatus.duration
        };

        // Reset vá» máº·c Ä‘á»‹nh (khÃ´ng xÃ³a message)
        maintenanceStatus.isEnabled = false;
        maintenanceStatus.lastUpdatedAt = new Date().toISOString();
        maintenanceStatus.lastUpdatedBy = 'Admin Whalio';

        // ThÃªm vÃ o lá»‹ch sá»­
        maintenanceStatus.history.push({
            action: 'cancelled',
            type: 'planned',
            cancelledSchedule: cancelledSchedule,
            timestamp: new Date().toISOString(),
            performedBy: 'Admin Whalio'
        });

        console.log('âŒ ÄÃ£ Há»¦Y lá»‹ch báº£o trÃ¬:');
        console.log(`   NgÃ y Ä‘Ã£ há»§y: ${cancelledSchedule.scheduledDate} ${cancelledSchedule.startTime}`);

        // ThÃªm system event
        mockSystemEvents.unshift({
            id: mockSystemEvents.length + 1,
            type: 'system',
            severity: 'info',
            title: 'Lá»‹ch báº£o trÃ¬ Ä‘Ã£ há»§y',
            description: `ÄÃ£ há»§y báº£o trÃ¬ ${cancelledSchedule.scheduledDate} ${cancelledSchedule.startTime}`,
            timestamp: new Date().toISOString(),
            relativeTime: 'Vá»«a xong',
            details: cancelledSchedule
        });

        res.json({
            success: true,
            data: {
                cancelledSchedule: cancelledSchedule,
                isEnabled: maintenanceStatus.isEnabled
            },
            message: 'ÄÃ£ há»§y lá»‹ch báº£o trÃ¬ thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error cancelling maintenance:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi há»§y lá»‹ch báº£o trÃ¬'
        });
    }
});

/**
 * GET /maintenance/history
 * Láº¥y lá»‹ch sá»­ cÃ¡c láº§n báº£o trÃ¬
 */
router.get('/maintenance/history', (req, res) => {
    try {
        const { limit = 20, page = 1 } = req.query;

        const history = [...maintenanceStatus.history].reverse(); // Má»›i nháº¥t lÃªn Ä‘áº§u

        // PhÃ¢n trang
        const startIndex = (parseInt(page) - 1) * parseInt(limit);
        const endIndex = startIndex + parseInt(limit);
        const paginatedHistory = history.slice(startIndex, endIndex);

        // Thá»‘ng kÃª
        const stats = {
            total: history.length,
            enabled: history.filter(h => h.action === 'enabled').length,
            disabled: history.filter(h => h.action === 'disabled').length,
            scheduled: history.filter(h => h.action === 'scheduled').length,
            cancelled: history.filter(h => h.action === 'cancelled').length
        };

        res.json({
            success: true,
            data: {
                history: paginatedHistory,
                pagination: {
                    currentPage: parseInt(page),
                    totalPages: Math.ceil(history.length / parseInt(limit)),
                    totalItems: history.length
                },
                stats: stats
            },
            message: 'Láº¥y lá»‹ch sá»­ báº£o trÃ¬ thÃ nh cÃ´ng'
        });

    } catch (error) {
        console.error('âŒ Error fetching maintenance history:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi láº¥y lá»‹ch sá»­ báº£o trÃ¬'
        });
    }
});

/**
 * GET /maintenance/check
 * Endpoint cÃ´ng khai Ä‘á»ƒ client kiá»ƒm tra tráº¡ng thÃ¡i báº£o trÃ¬
 * (KhÃ´ng cáº§n auth, Ä‘á»ƒ client check trÆ°á»›c khi gá»i API khÃ¡c)
 */
router.get('/maintenance/check', (req, res) => {
    try {
        res.json({
            success: true,
            data: {
                isEnabled: maintenanceStatus.isEnabled,
                message: maintenanceStatus.isEnabled ? maintenanceStatus.message : null,
                scheduledDate: maintenanceStatus.isEnabled ? maintenanceStatus.scheduledDate : null,
                estimatedDowntime: maintenanceStatus.isEnabled ? maintenanceStatus.estimatedDowntime : null
            },
            message: maintenanceStatus.isEnabled 
                ? 'Há»‡ thá»‘ng Ä‘ang báº£o trÃ¬' 
                : 'Há»‡ thá»‘ng hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng'
        });

    } catch (error) {
        console.error('âŒ Error checking maintenance:', error);
        res.status(500).json({
            success: false,
            data: null,
            message: 'Lá»—i khi kiá»ƒm tra tráº¡ng thÃ¡i'
        });
    }
});

// ==================== EXPORT MAINTENANCE MIDDLEWARE ====================
// Export Ä‘á»ƒ sá»­ dá»¥ng trong server/index.js
router.maintenanceCheck = maintenanceCheck;
router.maintenanceStatus = maintenanceStatus;

// ==================== HELPER FUNCTIONS ====================

function generateRandomPassword(length = 10) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

function formatMinutesToHours(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
}

/**
 * Chuyá»ƒn Ä‘á»•i dung lÆ°á»£ng tá»« bytes sang Ä‘á»‹nh dáº¡ng dá»… Ä‘á»c (KB, MB, GB, TB)
 * @param {number} bytes - Sá»‘ byte cáº§n chuyá»ƒn Ä‘á»•i
 * @param {number} decimals - Sá»‘ chá»¯ sá»‘ tháº­p phÃ¢n (máº·c Ä‘á»‹nh 2)
 * @returns {string} - Chuá»—i Ä‘Ã£ format (vÃ­ dá»¥: "2.4 GB")
 */
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

module.exports = router;
